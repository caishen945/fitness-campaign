<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录修复测试 - FitChallenge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        #console { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 登录修复测试页面</h1>
        
        <div class="test-section">
            <div class="test-title">测试说明</div>
            <p>本页面用于测试修复后的管理员登录功能：</p>
            <ul>
                <li>✅ 修复了版本配置中的错误端口信息</li>
                <li>✅ 修复了登录页面显示的错误测试凭据</li>
                <li>✅ 增强了表单提交事件处理，防止页面刷新</li>
                <li>✅ 改进了事件监听器绑定机制</li>
                <li>✅ 添加了详细的调试日志</li>
            </ul>
        </div>

        <div class="test-section">
            <div class="test-title">1. 测试API连接</div>
            <button id="test-api" class="btn btn-primary">测试API连接</button>
            <div id="api-result" class="mt-2"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. 测试登录功能</div>
            <form id="testLoginForm" class="mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" id="testUsername" class="form-control" placeholder="用户名" value="admin">
                    </div>
                    <div class="col-md-4">
                        <input type="password" id="testPassword" class="form-control" placeholder="密码" value="admin123">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" id="test-login" class="btn btn-success">测试登录</button>
                    </div>
                </div>
            </form>
            <div id="login-result" class="mt-2"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. 检查localStorage</div>
            <button id="check-storage" class="btn btn-info">检查存储状态</button>
            <button id="clear-storage" class="btn btn-warning ms-2">清除存储</button>
            <div id="storage-result" class="mt-2"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. 跳转到主系统</div>
            <button id="go-to-main" class="btn btn-primary">跳转到管理员系统</button>
            <div class="mt-2">
                <small class="text-muted">点击后将跳转到 http://127.0.0.1:8081</small>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">实时控制台日志</div>
            <div id="console"></div>
            <button id="clear-console" class="btn btn-sm btn-secondary mt-2">清除日志</button>
        </div>
    </div>

    <script>
        // 日志功能
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const console = document.getElementById('console');
            const colorMap = {
                'success': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12',
                'info': '#3498db'
            };
            
            console.innerHTML += `<div style="color: ${colorMap[type] || '#ecf0f1'};">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        // 1. 测试API连接
        document.getElementById('test-api').addEventListener('click', async () => {
            const resultEl = document.getElementById('api-result');
            log('开始测试API连接...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/health', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.text();
                    log('✅ API连接成功', 'success');
                    resultEl.innerHTML = '<div class="alert alert-success">✅ API服务器连接正常</div>';
                } else {
                    log(`⚠️ API响应异常: ${response.status}`, 'warning');
                    resultEl.innerHTML = `<div class="alert alert-warning">⚠️ API响应状态: ${response.status}</div>`;
                }
            } catch (error) {
                log(`❌ API连接失败: ${error.message}`, 'error');
                resultEl.innerHTML = `<div class="alert alert-danger">❌ 连接失败: ${error.message}</div>`;
            }
        });

        // 2. 测试登录功能
        document.getElementById('testLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('testUsername').value.trim();
            const password = document.getElementById('testPassword').value.trim();
            const resultEl = document.getElementById('login-result');
            const btn = document.getElementById('test-login');
            
            log(`开始测试登录: ${username}`, 'info');
            
            btn.disabled = true;
            btn.textContent = '登录中...';
            
            try {
                const response = await fetch('http://localhost:3000/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                log(`登录响应: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    log('✅ 登录成功', 'success');
                    
                    // 保存到localStorage
                    localStorage.setItem('adminToken', result.data.token);
                    localStorage.setItem('adminUser', JSON.stringify(result.data.admin));
                    
                    resultEl.innerHTML = `
                        <div class="alert alert-success">
                            ✅ 登录成功！<br>
                            Token: ${result.data.token.substring(0, 50)}...<br>
                            用户: ${result.data.admin.username}
                        </div>
                    `;
                } else {
                    log(`❌ 登录失败: ${result.message}`, 'error');
                    resultEl.innerHTML = `<div class="alert alert-danger">❌ 登录失败: ${result.message}</div>`;
                }
            } catch (error) {
                log(`💥 登录错误: ${error.message}`, 'error');
                resultEl.innerHTML = `<div class="alert alert-danger">💥 登录错误: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '测试登录';
            }
        });

        // 3. 检查localStorage
        document.getElementById('check-storage').addEventListener('click', () => {
            const resultEl = document.getElementById('storage-result');
            const adminToken = localStorage.getItem('adminToken');
            const adminUser = localStorage.getItem('adminUser');
            
            log('检查localStorage状态', 'info');
            
            if (adminToken && adminUser) {
                try {
                    const user = JSON.parse(adminUser);
                    log('✅ 发现认证信息', 'success');
                    resultEl.innerHTML = `
                        <div class="alert alert-success">
                            ✅ 已找到认证信息<br>
                            Token: ${adminToken.substring(0, 50)}...<br>
                            用户: ${user.username}<br>
                            角色: ${user.role}
                        </div>
                    `;
                } catch (error) {
                    log('❌ 认证信息解析失败', 'error');
                    resultEl.innerHTML = '<div class="alert alert-danger">❌ 认证信息格式错误</div>';
                }
            } else {
                log('⚠️ 未找到认证信息', 'warning');
                resultEl.innerHTML = '<div class="alert alert-warning">⚠️ 未找到认证信息</div>';
            }
        });

        // 清除存储
        document.getElementById('clear-storage').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            log('🗑️ 已清除存储', 'info');
            document.getElementById('storage-result').innerHTML = '<div class="alert alert-info">🗑️ 存储已清除</div>';
        });

        // 4. 跳转到主系统
        document.getElementById('go-to-main').addEventListener('click', () => {
            log('🔄 跳转到管理员系统', 'info');
            window.location.href = 'http://127.0.0.1:8081';
        });

        // 清除控制台
        document.getElementById('clear-console').addEventListener('click', () => {
            document.getElementById('console').innerHTML = '';
        });

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 登录修复测试页面已加载', 'success');
            log('准备测试修复后的登录功能...', 'info');
            
            // 自动检查存储状态
            setTimeout(() => {
                document.getElementById('check-storage').click();
            }, 500);
        });
    </script>
</body>
</html>
