<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•ä¿®å¤æµ‹è¯• - FitChallenge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .test-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        #console { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç™»å½•ä¿®å¤æµ‹è¯•é¡µé¢</h1>
        
        <div class="test-section">
            <div class="test-title">æµ‹è¯•è¯´æ˜</div>
            <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„ç®¡ç†å‘˜ç™»å½•åŠŸèƒ½ï¼š</p>
            <ul>
                <li>âœ… ä¿®å¤äº†ç‰ˆæœ¬é…ç½®ä¸­çš„é”™è¯¯ç«¯å£ä¿¡æ¯</li>
                <li>âœ… ä¿®å¤äº†ç™»å½•é¡µé¢æ˜¾ç¤ºçš„é”™è¯¯æµ‹è¯•å‡­æ®</li>
                <li>âœ… å¢å¼ºäº†è¡¨å•æäº¤äº‹ä»¶å¤„ç†ï¼Œé˜²æ­¢é¡µé¢åˆ·æ–°</li>
                <li>âœ… æ”¹è¿›äº†äº‹ä»¶ç›‘å¬å™¨ç»‘å®šæœºåˆ¶</li>
                <li>âœ… æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—</li>
            </ul>
        </div>

        <div class="test-section">
            <div class="test-title">1. æµ‹è¯•APIè¿æ¥</div>
            <button id="test-api" class="btn btn-primary">æµ‹è¯•APIè¿æ¥</button>
            <div id="api-result" class="mt-2"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. æµ‹è¯•ç™»å½•åŠŸèƒ½</div>
            <form id="testLoginForm" class="mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" id="testUsername" class="form-control" placeholder="ç”¨æˆ·å" value="admin">
                    </div>
                    <div class="col-md-4">
                        <input type="password" id="testPassword" class="form-control" placeholder="å¯†ç " value="admin123">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" id="test-login" class="btn btn-success">æµ‹è¯•ç™»å½•</button>
                    </div>
                </div>
            </form>
            <div id="login-result" class="mt-2"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. æ£€æŸ¥localStorage</div>
            <button id="check-storage" class="btn btn-info">æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>
            <button id="clear-storage" class="btn btn-warning ms-2">æ¸…é™¤å­˜å‚¨</button>
            <div id="storage-result" class="mt-2"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. è·³è½¬åˆ°ä¸»ç³»ç»Ÿ</div>
            <button id="go-to-main" class="btn btn-primary">è·³è½¬åˆ°ç®¡ç†å‘˜ç³»ç»Ÿ</button>
            <div class="mt-2">
                <small class="text-muted">ç‚¹å‡»åå°†è·³è½¬åˆ° http://127.0.0.1:8081</small>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">å®æ—¶æ§åˆ¶å°æ—¥å¿—</div>
            <div id="console"></div>
            <button id="clear-console" class="btn btn-sm btn-secondary mt-2">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        // æ—¥å¿—åŠŸèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const console = document.getElementById('console');
            const colorMap = {
                'success': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12',
                'info': '#3498db'
            };
            
            console.innerHTML += `<div style="color: ${colorMap[type] || '#ecf0f1'};">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        // 1. æµ‹è¯•APIè¿æ¥
        document.getElementById('test-api').addEventListener('click', async () => {
            const resultEl = document.getElementById('api-result');
            log('å¼€å§‹æµ‹è¯•APIè¿æ¥...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/health', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.text();
                    log('âœ… APIè¿æ¥æˆåŠŸ', 'success');
                    resultEl.innerHTML = '<div class="alert alert-success">âœ… APIæœåŠ¡å™¨è¿æ¥æ­£å¸¸</div>';
                } else {
                    log(`âš ï¸ APIå“åº”å¼‚å¸¸: ${response.status}`, 'warning');
                    resultEl.innerHTML = `<div class="alert alert-warning">âš ï¸ APIå“åº”çŠ¶æ€: ${response.status}</div>`;
                }
            } catch (error) {
                log(`âŒ APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                resultEl.innerHTML = `<div class="alert alert-danger">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        });

        // 2. æµ‹è¯•ç™»å½•åŠŸèƒ½
        document.getElementById('testLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('testUsername').value.trim();
            const password = document.getElementById('testPassword').value.trim();
            const resultEl = document.getElementById('login-result');
            const btn = document.getElementById('test-login');
            
            log(`å¼€å§‹æµ‹è¯•ç™»å½•: ${username}`, 'info');
            
            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';
            
            try {
                const response = await fetch('http://localhost:3000/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                log(`ç™»å½•å“åº”: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    log('âœ… ç™»å½•æˆåŠŸ', 'success');
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('adminToken', result.data.token);
                    localStorage.setItem('adminUser', JSON.stringify(result.data.admin));
                    
                    resultEl.innerHTML = `
                        <div class="alert alert-success">
                            âœ… ç™»å½•æˆåŠŸï¼<br>
                            Token: ${result.data.token.substring(0, 50)}...<br>
                            ç”¨æˆ·: ${result.data.admin.username}
                        </div>
                    `;
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${result.message}`, 'error');
                    resultEl.innerHTML = `<div class="alert alert-danger">âŒ ç™»å½•å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                log(`ğŸ’¥ ç™»å½•é”™è¯¯: ${error.message}`, 'error');
                resultEl.innerHTML = `<div class="alert alert-danger">ğŸ’¥ ç™»å½•é”™è¯¯: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•ç™»å½•';
            }
        });

        // 3. æ£€æŸ¥localStorage
        document.getElementById('check-storage').addEventListener('click', () => {
            const resultEl = document.getElementById('storage-result');
            const adminToken = localStorage.getItem('adminToken');
            const adminUser = localStorage.getItem('adminUser');
            
            log('æ£€æŸ¥localStorageçŠ¶æ€', 'info');
            
            if (adminToken && adminUser) {
                try {
                    const user = JSON.parse(adminUser);
                    log('âœ… å‘ç°è®¤è¯ä¿¡æ¯', 'success');
                    resultEl.innerHTML = `
                        <div class="alert alert-success">
                            âœ… å·²æ‰¾åˆ°è®¤è¯ä¿¡æ¯<br>
                            Token: ${adminToken.substring(0, 50)}...<br>
                            ç”¨æˆ·: ${user.username}<br>
                            è§’è‰²: ${user.role}
                        </div>
                    `;
                } catch (error) {
                    log('âŒ è®¤è¯ä¿¡æ¯è§£æå¤±è´¥', 'error');
                    resultEl.innerHTML = '<div class="alert alert-danger">âŒ è®¤è¯ä¿¡æ¯æ ¼å¼é”™è¯¯</div>';
                }
            } else {
                log('âš ï¸ æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯', 'warning');
                resultEl.innerHTML = '<div class="alert alert-warning">âš ï¸ æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯</div>';
            }
        });

        // æ¸…é™¤å­˜å‚¨
        document.getElementById('clear-storage').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            log('ğŸ—‘ï¸ å·²æ¸…é™¤å­˜å‚¨', 'info');
            document.getElementById('storage-result').innerHTML = '<div class="alert alert-info">ğŸ—‘ï¸ å­˜å‚¨å·²æ¸…é™¤</div>';
        });

        // 4. è·³è½¬åˆ°ä¸»ç³»ç»Ÿ
        document.getElementById('go-to-main').addEventListener('click', () => {
            log('ğŸ”„ è·³è½¬åˆ°ç®¡ç†å‘˜ç³»ç»Ÿ', 'info');
            window.location.href = 'http://127.0.0.1:8081';
        });

        // æ¸…é™¤æ§åˆ¶å°
        document.getElementById('clear-console').addEventListener('click', () => {
            document.getElementById('console').innerHTML = '';
        });

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ ç™»å½•ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('å‡†å¤‡æµ‹è¯•ä¿®å¤åçš„ç™»å½•åŠŸèƒ½...', 'info');
            
            // è‡ªåŠ¨æ£€æŸ¥å­˜å‚¨çŠ¶æ€
            setTimeout(() => {
                document.getElementById('check-storage').click();
            }, 500);
        });
    </script>
</body>
</html>
