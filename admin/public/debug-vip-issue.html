<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” VIPé—®é¢˜è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .network-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .network-log.request { border-left: 4px solid #007bff; }
        .network-log.response { border-left: 4px solid #28a745; }
        .network-log.error { border-left: 4px solid #dc3545; }
        
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” VIPé—®é¢˜è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1. ç³»ç»ŸçŠ¶æ€æ£€æŸ?/h2>
        <button onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€?/button>
        <div id="systemStatus"></div>
    </div>

    <div class="debug-section">
        <h2>2. æ¨¡æ‹ŸVIPç¼–è¾‘æ“ä½œ</h2>
        <div class="form-group">
            <label>VIPç­‰çº§ID:</label>
            <input type="number" id="vipLevelId" value="1" min="1">
        </div>
        <div class="form-group">
            <label>ç­‰çº§åç§°:</label>
            <input type="text" id="vipLevelName" value="æµ‹è¯•ç­‰çº§">
        </div>
        <div class="form-group">
            <label>æ­¥æ•°ç›®æ ‡:</label>
            <input type="number" id="vipStepGoal" value="1000" min="1">
        </div>
        <div class="form-group">
            <label>å­˜æ¬¾è¦æ±‚:</label>
            <input type="number" id="vipDeposit" value="100" min="0" step="0.01">
        </div>
        <div class="form-group">
            <label>å¥–åŠ±é‡‘é¢:</label>
            <input type="number" id="vipReward" value="50" min="0" step="0.01">
        </div>
        <div class="form-group">
            <label>æŒ‘æˆ˜æ¬¡æ•°:</label>
            <input type="number" id="vipChallengeTimes" value="3" min="1">
        </div>
        
        <button onclick="simulateVipEdit()">æ¨¡æ‹ŸVIPç¼–è¾‘</button>
        <button onclick="simulateVipCreate()">æ¨¡æ‹ŸVIPåˆ›å»º</button>
        <button onclick="clearNetworkLogs()" class="danger">æ¸…é™¤ç½‘ç»œæ—¥å¿—</button>
    </div>

    <div class="debug-section">
        <h2>3. ç½‘ç»œè¯·æ±‚ç›‘æ§</h2>
        <div id="networkLogs"></div>
    </div>

    <div class="debug-section">
        <h2>4. å®æ—¶æ—¥å¿—ç›‘æ§</h2>
        <button onclick="startLogMonitoring()">å¼€å§‹ç›‘æ?/button>
        <button onclick="stopLogMonitoring()">åœæ­¢ç›‘æ§</button>
        <div id="realTimeLogs" class="log-output"></div>
    </div>

    <div class="debug-section">
        <h2>5. é—®é¢˜è¯Šæ–­</h2>
        <button onclick="diagnoseVipIssue()">è¯Šæ–­VIPé—®é¢˜</button>
        <div id="diagnosisResult"></div>
    </div>

    <script>
        let logMonitoring = false;
        let networkLogs = [];

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€?
        async function checkSystemStatus() {
            const output = document.getElementById('systemStatus');
            let status = '<h3>ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ç»“æ?</h3>';
            
            try {
                // æ£€æŸ¥åç«¯æœåŠ?
                const backendResponse = await fetch('http://localhost:3000/api', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (backendResponse.ok) {
                    status += '<div><span class="status-indicator status-success"></span>åç«¯æœåŠ¡æ­£å¸¸</div>';
                } else {
                    status += '<div><span class="status-indicator status-error"></span>åç«¯æœåŠ¡å¼‚å¸¸</div>';
                }
                
                // æ£€æŸ¥ç®¡ç†å‘˜è®¤è¯
                const adminToken = localStorage.getItem('adminToken');
                if (adminToken) {
                    status += '<div><span class="status-indicator status-success"></span>ç®¡ç†å‘˜Tokenå­˜åœ¨</div>';
                    
                    // éªŒè¯Tokenæœ‰æ•ˆæ€?
                    const authResponse = await fetch('http://localhost:3000/api/admin/vip-levels', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                    
                    if (authResponse.ok) {
                        status += '<div><span class="status-indicator status-success"></span>ç®¡ç†å‘˜Tokenæœ‰æ•ˆ</div>';
                    } else {
                        status += '<div><span class="status-indicator status-error"></span>ç®¡ç†å‘˜Tokenæ— æ•ˆ</div>';
                    }
                } else {
                    status += '<div><span class="status-indicator status-warning"></span>ç®¡ç†å‘˜Tokenä¸å­˜åœ?/div>';
                }
                
                // æ£€æŸ¥æ—¥å¿—ç³»ç»?
                const adminLogs = localStorage.getItem('adminLogs');
                if (adminLogs) {
                    const logsCount = JSON.parse(adminLogs).length;
                    status += `<div><span class="status-indicator status-info"></span>æœ¬åœ°æ—¥å¿—: ${logsCount} æ?/div>`;
                } else {
                    status += '<div><span class="status-indicator status-warning"></span>æœ¬åœ°æ—¥å¿—ä¸ºç©º</div>';
                }
                
            } catch (error) {
                status += `<div><span class="status-indicator status-error"></span>æ£€æŸ¥å¤±è´? ${error.message}</div>`;
            }
            
            output.innerHTML = status;
        }

        // æ¨¡æ‹ŸVIPç¼–è¾‘
        async function simulateVipEdit() {
            const levelId = document.getElementById('vipLevelId').value;
            const levelName = document.getElementById('vipLevelName').value;
            const stepGoal = document.getElementById('vipStepGoal').value;
            const deposit = document.getElementById('vipDeposit').value;
            const reward = document.getElementById('vipReward').value;
            const challengeTimes = document.getElementById('vipChallengeTimes').value;
            
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken) {
                alert('â?è¯·å…ˆç™»å½•ç®¡ç†å‘˜åå?);
                return;
            }
            
            const requestData = {
                name: levelName,
                stepGoal: parseInt(stepGoal),
                deposit: parseFloat(deposit),
                reward: parseFloat(reward),
                challengeTimes: parseInt(challengeTimes)
            };
            
            logNetworkRequest('PUT', `/api/admin/vip-levels/${levelId}`, requestData);
            
            try {
                const response = await fetch(`http://localhost:3000/api/admin/vip-levels/${levelId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.text();
                logNetworkResponse('PUT', `/api/admin/vip-levels/${levelId}`, response.status, responseData);
                
                if (response.ok) {
                    alert('âœ?VIPç¼–è¾‘æˆåŠŸï¼?);
                } else {
                    alert(`â?VIPç¼–è¾‘å¤±è´¥: ${response.status} - ${responseData}`);
                }
                
            } catch (error) {
                logNetworkError('PUT', `/api/admin/vip-levels/${levelId}`, error);
                alert(`â?ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // æ¨¡æ‹ŸVIPåˆ›å»º
        async function simulateVipCreate() {
            const levelName = document.getElementById('vipLevelName').value;
            const stepGoal = document.getElementById('vipStepGoal').value;
            const deposit = document.getElementById('vipDeposit').value;
            const reward = document.getElementById('vipReward').value;
            const challengeTimes = document.getElementById('vipChallengeTimes').value;
            
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken) {
                alert('â?è¯·å…ˆç™»å½•ç®¡ç†å‘˜åå?);
                return;
            }
            
            const requestData = {
                name: levelName,
                stepGoal: parseInt(stepGoal),
                deposit: parseFloat(deposit),
                reward: parseFloat(reward),
                challengeTimes: parseInt(challengeTimes)
            };
            
            logNetworkRequest('POST', '/api/admin/vip-levels', requestData);
            
            try {
                const response = await fetch('http://localhost:3000/api/admin/vip-levels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                const responseData = await response.text();
                logNetworkResponse('POST', '/api/admin/vip-levels', response.status, responseData);
                
                if (response.ok) {
                    alert('âœ?VIPåˆ›å»ºæˆåŠŸï¼?);
                } else {
                    alert(`â?VIPåˆ›å»ºå¤±è´¥: ${response.status} - ${responseData}`);
                }
                
            } catch (error) {
                logNetworkError('POST', '/api/admin/vip-levels', error);
                alert(`â?ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // è®°å½•ç½‘ç»œè¯·æ±‚
        function logNetworkRequest(method, url, data) {
            const log = {
                timestamp: new Date().toISOString(),
                type: 'request',
                method: method,
                url: url,
                data: data
            };
            networkLogs.push(log);
            updateNetworkLogs();
        }

        // è®°å½•ç½‘ç»œå“åº”
        function logNetworkResponse(method, url, status, data) {
            const log = {
                timestamp: new Date().toISOString(),
                type: 'response',
                method: method,
                url: url,
                status: status,
                data: data
            };
            networkLogs.push(log);
            updateNetworkLogs();
        }

        // è®°å½•ç½‘ç»œé”™è¯¯
        function logNetworkError(method, url, error) {
            const log = {
                timestamp: new Date().toISOString(),
                type: 'error',
                method: method,
                url: url,
                error: error.message
            };
            networkLogs.push(log);
            updateNetworkLogs();
        }

        // æ›´æ–°ç½‘ç»œæ—¥å¿—æ˜¾ç¤º
        function updateNetworkLogs() {
            const container = document.getElementById('networkLogs');
            const recentLogs = networkLogs.slice(-20); // åªæ˜¾ç¤ºæœ€è¿?0æ?
            
            let html = '';
            recentLogs.forEach(log => {
                const logClass = log.type === 'request' ? 'request' : 
                               log.type === 'response' ? 'response' : 'error';
                
                html += `<div class="network-log ${logClass}">`;
                html += `[${log.timestamp}] ${log.method} ${log.url}`;
                
                if (log.type === 'request') {
                    html += `<br>è¯·æ±‚æ•°æ®: ${JSON.stringify(log.data, null, 2)}`;
                } else if (log.type === 'response') {
                    html += `<br>çŠ¶æ€? ${log.status}`;
                    html += `<br>å“åº”æ•°æ®: ${log.data}`;
                } else if (log.type === 'error') {
                    html += `<br>é”™è¯¯: ${log.error}`;
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // æ¸…é™¤ç½‘ç»œæ—¥å¿—
        function clearNetworkLogs() {
            networkLogs = [];
            updateNetworkLogs();
        }

        // å¼€å§‹æ—¥å¿—ç›‘æ?
        function startLogMonitoring() {
            logMonitoring = true;
            const output = document.getElementById('realTimeLogs');
            output.textContent = 'å¼€å§‹ç›‘æ§æ—¥å¿?..\n';
            
            // ç›‘æ§localStorageå˜åŒ–
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (logMonitoring && (key === 'adminLogs' || key === 'frontendLogs')) {
                    try {
                        const logs = JSON.parse(value);
                        const latestLog = logs[logs.length - 1];
                        if (latestLog) {
                            output.textContent += `[${latestLog.timestamp}] [${latestLog.level}] [${latestLog.category}] ${latestLog.message}\n`;
                            output.scrollTop = output.scrollHeight;
                        }
                    } catch (e) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                }
                originalSetItem.apply(this, arguments);
            };
            
            alert('âœ?æ—¥å¿—ç›‘æ§å·²å¼€å§?);
        }

        // åœæ­¢æ—¥å¿—ç›‘æ§
        function stopLogMonitoring() {
            logMonitoring = false;
            alert('â¹ï¸ æ—¥å¿—ç›‘æ§å·²åœæ­?);
        }

        // è¯Šæ–­VIPé—®é¢˜
        async function diagnoseVipIssue() {
            const output = document.getElementById('diagnosisResult');
            let diagnosis = '<h3>VIPé—®é¢˜è¯Šæ–­ç»“æœ:</h3>';
            
            try {
                // æ£€æŸ¥æœ€è¿‘çš„ç½‘ç»œæ—¥å¿—
                const recentErrors = networkLogs.filter(log => log.type === 'error');
                const recentResponses = networkLogs.filter(log => log.type === 'response' && log.status >= 400);
                
                if (recentErrors.length > 0) {
                    diagnosis += '<div><span class="status-indicator status-error"></span>å‘ç°ç½‘ç»œé”™è¯¯</div>';
                    recentErrors.forEach(error => {
                        diagnosis += `<div style="margin-left: 20px;">- ${error.method} ${error.url}: ${error.error}</div>`;
                    });
                }
                
                if (recentResponses.length > 0) {
                    diagnosis += '<div><span class="status-indicator status-warning"></span>å‘ç°HTTPé”™è¯¯å“åº”</div>';
                    recentResponses.forEach(response => {
                        diagnosis += `<div style="margin-left: 20px;">- ${response.method} ${response.url}: ${response.status}</div>`;
                        diagnosis += `<div style="margin-left: 40px; font-size: 12px;">å“åº”: ${response.data}</div>`;
                    });
                }
                
                // æ£€æŸ¥TokençŠ¶æ€?
                const adminToken = localStorage.getItem('adminToken');
                if (!adminToken) {
                    diagnosis += '<div><span class="status-indicator status-error"></span>ç®¡ç†å‘˜Tokenä¸å­˜åœ?/div>';
                } else {
                    // éªŒè¯Token
                    const authResponse = await fetch('http://localhost:3000/api/admin/vip-levels', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                    
                    if (authResponse.status === 401) {
                        diagnosis += '<div><span class="status-indicator status-error"></span>ç®¡ç†å‘˜Tokenå·²è¿‡æœ?/div>';
                    } else if (authResponse.ok) {
                        diagnosis += '<div><span class="status-indicator status-success"></span>ç®¡ç†å‘˜Tokenæœ‰æ•ˆ</div>';
                    }
                }
                
                // æ£€æŸ¥æ—¥å¿—æ•°æ?
                const adminLogs = localStorage.getItem('adminLogs');
                if (adminLogs) {
                    const logs = JSON.parse(adminLogs);
                    const vipLogs = logs.filter(log => log.category === 'VIP-MANAGEMENT');
                    const errorLogs = logs.filter(log => log.level === 'ERROR');
                    
                    diagnosis += `<div><span class="status-indicator status-info"></span>VIPæ“ä½œæ—¥å¿—: ${vipLogs.length} æ?/div>`;
                    diagnosis += `<div><span class="status-indicator status-info"></span>é”™è¯¯æ—¥å¿—: ${errorLogs.length} æ?/div>`;
                    
                    if (errorLogs.length > 0) {
                        diagnosis += '<div><span class="status-indicator status-warning"></span>æœ€è¿‘çš„é”™è¯¯:</div>';
                        errorLogs.slice(-3).forEach(log => {
                            diagnosis += `<div style="margin-left: 20px;">- ${log.message}</div>`;
                        });
                    }
                }
                
                if (recentErrors.length === 0 && recentResponses.length === 0) {
                    diagnosis += '<div><span class="status-indicator status-success"></span>æœªå‘ç°æ˜æ˜¾çš„ç½‘ç»œé—®é¢˜</div>';
                }
                
            } catch (error) {
                diagnosis += `<div><span class="status-indicator status-error"></span>è¯Šæ–­å¤±è´¥: ${error.message}</div>`;
            }
            
            output.innerHTML = diagnosis;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€?
        window.addEventListener('load', () => {
            setTimeout(checkSystemStatus, 1000);
        });
    </script>
</body>
</html>
