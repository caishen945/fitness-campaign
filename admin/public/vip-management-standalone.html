<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPç®¡ç† - ç‹¬ç«‹ç‰ˆæœ¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { margin: 2px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .loading { text-align: center; padding: 20px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-crown"></i> VIPç­‰çº§ç®¡ç† - ç‹¬ç«‹ç‰ˆæœ¬</h1>
            <p class="text-muted">æ­¤ç‰ˆæœ¬å·²ä¿®å¤å­—æ®µæ˜ å°„é—®é¢˜ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®æ˜¾ç¤?/p>
            <button class="btn btn-primary" onclick="loadVipLevels()">
                <i class="fas fa-sync"></i> åˆ·æ–°æ•°æ®
            </button>
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸?..
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>
            
            <div id="vipTable"></div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘VIPç­‰çº§</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label class="form-label">ç­‰çº§åç§°</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æŠ¼é‡‘é‡‘é¢ (USDT)</label>
                            <input type="number" class="form-control" id="editDeposit" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ­¥æ•°ç›®æ ‡</label>
                            <input type="number" class="form-control" id="editStepTarget" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ¯æ—¥å¥–åŠ± (USDT)</label>
                            <input type="number" class="form-control" id="editDailyReward" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æŒ‘æˆ˜å¤©æ•°</label>
                            <input type="number" class="form-control" id="editDuration" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æœ€å¤§æŒ‘æˆ˜æ¬¡æ•?/label>
                            <input type="number" class="form-control" id="editMaxChallenges" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editIsActive">
                                <label class="form-check-label">å¯ç”¨çŠ¶æ€?/label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveVipLevel()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let vipLevels = [];
        let editModal;

        // åˆå§‹åŒ?
        document.addEventListener('DOMContentLoaded', function() {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            loadVipLevels();
        });

        // åŠ è½½VIPç­‰çº§æ•°æ®
        async function loadVipLevels() {
            showLoading(true);
            hideMessages();
            
            try {
                const response = await fetch('http://localhost:3000/api/admin/vip-levels');
                const data = await response.json();
                
                if (data.success) {
                    vipLevels = data.data;
                    renderVipTable();
                    showSuccess('æ•°æ®åŠ è½½æˆåŠŸï¼?);
                } else {
                    showError('åŠ è½½å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æ¸²æŸ“VIPç­‰çº§è¡¨æ ¼
        function renderVipTable() {
            const tableContainer = document.getElementById('vipTable');
            
            if (vipLevels.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-muted">æš‚æ— VIPç­‰çº§æ•°æ®</p>';
                return;
            }

            let html = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç­‰çº§åç§°</th>
                            <th>æŠ¼é‡‘é‡‘é¢</th>
                            <th>æ­¥æ•°ç›®æ ‡</th>
                            <th>æ¯æ—¥å¥–åŠ±</th>
                            <th>æŒ‘æˆ˜å¤©æ•°</th>
                            <th>æœ€å¤§æŒ‘æˆ˜æ¬¡æ•?/th>
                            <th>çŠ¶æ€?/th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            vipLevels.forEach(level => {
                // ä½¿ç”¨ä¿®å¤åçš„å­—æ®µæ˜ å°„
                const maxChallenges = level.maxChallenges || level.challenge_times || level.challengeTimes || 0;
                const duration = level.duration || level.challenge_days || level.challengeDays || 0;
                const dailyReward = level.dailyReward || level.reward_amount || level.rewardAmount || 0;
                const stepTarget = level.stepTarget || level.step_target || 0;
                const depositAmount = level.depositAmount || level.deposit_amount || 0;
                const isActive = level.isActive !== undefined ? level.isActive : (level.is_active !== undefined ? level.is_active : true);

                html += `
                    <tr>
                        <td>${level.id}</td>
                        <td>${level.name || 'æœªçŸ¥'}</td>
                        <td>${depositAmount} USDT</td>
                        <td>${stepTarget} æ­?/td>
                        <td>${dailyReward} USDT</td>
                        <td>${duration} å¤?/td>
                        <td>${maxChallenges} æ¬?/td>
                        <td>
                            <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                ${isActive ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editVipLevel(${level.id})">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // ç¼–è¾‘VIPç­‰çº§
        function editVipLevel(id) {
            const level = vipLevels.find(l => l.id === id);
            if (!level) return;

            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('editId').value = level.id;
            document.getElementById('editName').value = level.name || '';
            document.getElementById('editDeposit').value = level.depositAmount || level.deposit_amount || 0;
            document.getElementById('editStepTarget').value = level.stepTarget || level.step_target || 0;
            document.getElementById('editDailyReward').value = level.dailyReward || level.reward_amount || level.rewardAmount || 0;
            document.getElementById('editDuration').value = level.duration || level.challenge_days || level.challengeDays || 0;
            document.getElementById('editMaxChallenges').value = level.maxChallenges || level.challenge_times || level.challengeTimes || 0;
            document.getElementById('editIsActive').checked = level.isActive !== undefined ? level.isActive : (level.is_active !== undefined ? level.is_active : true);

            editModal.show();
        }

        // ä¿å­˜VIPç­‰çº§
        async function saveVipLevel() {
            const id = document.getElementById('editId').value;
            const formData = {
                name: document.getElementById('editName').value,
                depositAmount: parseFloat(document.getElementById('editDeposit').value) || 0,
                stepTarget: parseInt(document.getElementById('editStepTarget').value) || 0,
                dailyReward: parseFloat(document.getElementById('editDailyReward').value) || 0,
                duration: parseInt(document.getElementById('editDuration').value) || 1,
                maxChallenges: parseInt(document.getElementById('editMaxChallenges').value) || 1,
                isActive: document.getElementById('editIsActive').checked
            };

            try {
                const response = await fetch(`http://localhost:3000/api/admin/vip-levels/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    editModal.hide();
                    showSuccess('ä¿å­˜æˆåŠŸï¼?);
                    loadVipLevels(); // é‡æ–°åŠ è½½æ•°æ®
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('ä¿å­˜è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€?
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        // éšè—æ¶ˆæ¯
        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }
    </script>
</body>
</html>
