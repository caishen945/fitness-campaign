<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导航调试 - FitChallenge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .debug-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .debug-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        #console { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .nav-test { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 导航功能调试</h1>
        
        <div class="debug-section">
            <div class="debug-title">系统设置导航测试</div>
            <p>测试所有可能影响系统设置导航的因素：</p>
            
            <div class="nav-test">
                <button id="test-direct-navigate" class="btn btn-primary">直接调用navigate('settings')</button>
            </div>
            
            <div class="nav-test">
                <button id="test-keyboard-shortcut" class="btn btn-success">模拟键盘快捷键 Ctrl+9</button>
            </div>
            
            <div class="nav-test">
                <button id="test-click-event" class="btn btn-info">模拟点击导航链接</button>
            </div>
            
            <div class="nav-test">
                <button id="test-page-config" class="btn btn-warning">检查页面配置</button>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-title">模拟导航菜单</div>
            <div class="card">
                <div class="card-body">
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 5px 0;">
                            <a href="#" data-page="dashboard" class="nav-link" style="color: #2c3e50; text-decoration: none; padding: 10px; display: block; border: 1px solid #ddd; border-radius: 5px;">
                                <i class="fas fa-tachometer-alt"></i> 仪表盘 (dashboard)
                            </a>
                        </li>
                        <li style="margin: 5px 0;">
                            <a href="#" data-page="users" class="nav-link" style="color: #2c3e50; text-decoration: none; padding: 10px; display: block; border: 1px solid #ddd; border-radius: 5px;">
                                <i class="fas fa-users"></i> 用户管理 (users)
                            </a>
                        </li>
                        <li style="margin: 5px 0;">
                            <a href="#" data-page="settings" class="nav-link" style="color: #2c3e50; text-decoration: none; padding: 10px; display: block; border: 1px solid #ddd; border-radius: 5px; background: #e8f5e8;">
                                <i class="fas fa-cogs"></i> 系统设置 (settings) ← 测试目标
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-title">实时调试日志</div>
            <div id="console"></div>
            <button id="clear-console" class="btn btn-sm btn-secondary mt-2">清除日志</button>
        </div>
    </div>

    <script type="module">
        // 日志功能
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const console = document.getElementById('console');
            const colorMap = {
                'success': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12',
                'info': '#3498db'
            };
            
            console.innerHTML += `<div style="color: ${colorMap[type] || '#ecf0f1'};">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        // 全局变量存储AdminApp实例
        let adminApp = null;

        // 初始化AdminApp
        async function initAdminApp() {
            try {
                log('🚀 开始初始化AdminApp...', 'info');
                
                const AppModule = await import('./src/App-fixed.js');
                const AdminApp = AppModule.default;
                
                adminApp = new AdminApp();
                
                // 模拟登录状态
                adminApp.isAuthenticated = true;
                adminApp.user = { username: 'debug_user' };
                adminApp.token = 'debug_token';
                
                log('✅ AdminApp初始化成功', 'success');
                log(`页面配置: ${Object.keys(adminApp.pages).join(', ')}`, 'info');
                
                return adminApp;
            } catch (error) {
                log(`❌ AdminApp初始化失败: ${error.message}`, 'error');
                throw error;
            }
        }

        // 测试直接导航
        document.getElementById('test-direct-navigate').addEventListener('click', async () => {
            log('🧪 测试直接导航到settings页面...', 'info');
            
            try {
                if (!adminApp) {
                    await initAdminApp();
                }
                
                log('📍 当前页面: ' + adminApp.currentPage, 'info');
                log('🔒 认证状态: ' + adminApp.isAuthenticated, 'info');
                
                // 直接调用navigate方法
                adminApp.navigate('settings');
                
                log('✅ navigate方法调用完成', 'success');
                log('📍 导航后页面: ' + adminApp.currentPage, 'info');
                
            } catch (error) {
                log(`❌ 直接导航失败: ${error.message}`, 'error');
                console.error('详细错误:', error);
            }
        });

        // 测试键盘快捷键
        document.getElementById('test-keyboard-shortcut').addEventListener('click', async () => {
            log('⌨️ 测试键盘快捷键 Ctrl+9...', 'info');
            
            try {
                if (!adminApp) {
                    await initAdminApp();
                }
                
                // 创建键盘事件
                const event = new KeyboardEvent('keydown', {
                    key: '9',
                    ctrlKey: true,
                    bubbles: true
                });
                
                log('🎯 派发键盘事件...', 'info');
                document.dispatchEvent(event);
                
                setTimeout(() => {
                    log('📍 键盘事件后页面: ' + adminApp.currentPage, 'info');
                }, 100);
                
            } catch (error) {
                log(`❌ 键盘快捷键测试失败: ${error.message}`, 'error');
            }
        });

        // 测试点击事件
        document.getElementById('test-click-event').addEventListener('click', async () => {
            log('🖱️ 测试点击导航链接...', 'info');
            
            try {
                if (!adminApp) {
                    await initAdminApp();
                }
                
                // 找到settings链接并模拟点击
                const settingsLink = document.querySelector('[data-page="settings"]');
                if (settingsLink) {
                    log('🎯 找到settings链接，模拟点击...', 'info');
                    
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true
                    });
                    
                    settingsLink.dispatchEvent(clickEvent);
                    
                    setTimeout(() => {
                        log('📍 点击事件后页面: ' + adminApp.currentPage, 'info');
                    }, 100);
                } else {
                    log('❌ 未找到settings链接', 'error');
                }
                
            } catch (error) {
                log(`❌ 点击事件测试失败: ${error.message}`, 'error');
            }
        });

        // 测试页面配置
        document.getElementById('test-page-config').addEventListener('click', async () => {
            log('🔍 检查页面配置详情...', 'info');
            
            try {
                if (!adminApp) {
                    await initAdminApp();
                }
                
                const settingsPage = adminApp.pages.settings;
                
                log('📋 settings页面配置:', 'info');
                log(`  - 存在: ${!!settingsPage}`, 'info');
                log(`  - 类: ${settingsPage?.Class?.name || '未定义'}`, 'info');
                log(`  - render方法: ${typeof settingsPage?.render}`, 'info');
                log(`  - afterRender方法: ${typeof settingsPage?.afterRender}`, 'info');
                log(`  - 实例: ${!!settingsPage?.instance}`, 'info');
                
                // 尝试创建实例
                if (settingsPage && settingsPage.Class) {
                    try {
                        const instance = new settingsPage.Class(adminApp);
                        log('✅ SystemSettings实例创建成功', 'success');
                        log(`  - 实例类型: ${instance.constructor.name}`, 'info');
                        log(`  - render方法: ${typeof instance.render}`, 'info');
                        
                        // 尝试渲染
                        await instance.loadVersionInfo();
                        const content = instance.render();
                        log(`✅ 页面渲染成功，内容长度: ${content.length}`, 'success');
                        
                    } catch (renderError) {
                        log(`❌ 实例创建或渲染失败: ${renderError.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`❌ 页面配置检查失败: ${error.message}`, 'error');
            }
        });

        // 设置导航链接的点击事件（模拟真实环境）
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-page]')) {
                e.preventDefault();
                const page = e.target.getAttribute('data-page');
                log(`🔗 导航链接被点击: ${page}`, 'info');
                
                if (adminApp) {
                    adminApp.navigate(page);
                } else {
                    log('❌ AdminApp未初始化', 'error');
                }
            }
        });

        // 清除控制台
        document.getElementById('clear-console').addEventListener('click', () => {
            document.getElementById('console').innerHTML = '';
        });

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 导航调试页面已加载', 'success');
            log('准备开始调试导航功能...', 'info');
            log('💡 提示: 请按顺序点击测试按钮', 'warning');
        });
    </script>
</body>
</html>
