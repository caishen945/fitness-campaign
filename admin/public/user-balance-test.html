<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ä½™é¢ç®¡ç†æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .table th { background-color: #f8f9fa; font-weight: 600; }
        .btn { margin: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-users"></i> ç”¨æˆ·ä½™é¢ç®¡ç†æµ‹è¯•</h2>
            </div>
            <div class="card-body">
                <div id="loadingMessage" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸?..
                </div>
                
                <div id="userList" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·ID</th>
                                    <th>ç”¨æˆ·å?/th>
                                    <th>é‚®ç®±</th>
                                    <th>å½“å‰ä½™é¢</th>
                                    <th>çŠ¶æ€?/th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½™é¢ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal fade" id="balanceModal" tabindex="-1" aria-labelledby="balanceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="balanceModalLabel">ä½™é¢ç®¡ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="userInfo" class="mb-3 p-3 bg-light rounded">
                        <!-- ç”¨æˆ·ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    
                    <form id="balanceForm">
                        <div class="mb-3">
                            <label for="balanceOperation" class="form-label">æ“ä½œç±»å‹</label>
                            <select class="form-select" id="balanceOperation" required>
                                <option value="add">ä½™é¢è°ƒæ•´(å¢åŠ )</option>
                                <option value="subtract">æ‰£æ¬¾</option>
                                <option value="freeze">å†»ç»“</option>
                                <option value="unfreeze">è§£å†»</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="balanceAmount" class="form-label">é‡‘é¢</label>
                            <input type="number" class="form-control" id="balanceAmount" step="0.01" min="0" placeholder="è¯·è¾“å…¥é‡‘é¢? required>
                        </div>
                        <div class="mb-3">
                            <label for="balanceNote" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="balanceNote" rows="3" placeholder="è¯·è¾“å…¥æ“ä½œå¤‡æ³?></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="executeBalanceBtn">æ‰§è¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class UserBalanceTest {
            constructor() {
                this.users = [];
                this.currentUser = null;
                this.init();
            }

            async init() {
                console.log('ğŸš€ ç”¨æˆ·ä½™é¢ç®¡ç†æµ‹è¯•åˆå§‹åŒ?..');
                await this.loadUsers();
                this.bindEvents();
            }

            async loadUsers() {
                try {
                    console.log('ğŸ“¡ å¼€å§‹åŠ è½½ç”¨æˆ·æ•°æ?..');
                    
                    // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®ï¼ˆå› ä¸ºéœ€è¦è®¤è¯ï¼‰
                    this.users = [
                        { id: 33, username: '161616', email: '161616@qq.com', balance: 100.50, status: 'active' },
                        { id: 34, username: 'testuser', email: 'test@example.com', balance: 50.00, status: 'active' }
                    ];
                    
                    console.log('âœ?ç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸ:', this.users);
                    this.renderUsers();
                } catch (error) {
                    console.error('â?åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                    this.showError('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥: ' + error.message);
                }
            }

            renderUsers() {
                const loadingMessage = document.getElementById('loadingMessage');
                const userList = document.getElementById('userList');
                const tbody = document.getElementById('userTableBody');

                if (this.users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem;">æš‚æ— ç”¨æˆ·æ•°æ®</td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = this.users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td><span class="badge bg-success">${user.balance} USDT</span></td>
                            <td>
                                <span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                    ${user.status === 'active' ? 'æ´»è·ƒ' : 'éæ´»è·?}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm manage-balance" data-user-id="${user.id}">
                                    <i class="fas fa-wallet"></i> ä½™é¢ç®¡ç†
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                loadingMessage.style.display = 'none';
                userList.style.display = 'block';
            }

            bindEvents() {
                // ä½™é¢ç®¡ç†æŒ‰é’®
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.manage-balance')) {
                        const userId = parseInt(e.target.closest('.manage-balance').getAttribute('data-user-id'));
                        const user = this.users.find(u => u.id === userId);
                        if (user) {
                            this.showBalanceModal(user);
                        }
                    }
                });

                // æ‰§è¡Œä½™é¢æ“ä½œæŒ‰é’®
                document.getElementById('executeBalanceBtn')?.addEventListener('click', () => {
                    this.executeBalanceOperation();
                });
            }

            showBalanceModal(user) {
                this.currentUser = user;
                const modal = new bootstrap.Modal(document.getElementById('balanceModal'));
                const userInfo = document.getElementById('userInfo');
                
                userInfo.innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <strong>ç”¨æˆ·:</strong> ${user.username}
                        </div>
                        <div class="col-6">
                            <strong>å½“å‰ä½™é¢:</strong> <span class="text-success fw-bold">${user.balance} USDT</span>
                        </div>
                    </div>
                `;
                
                // é‡ç½®è¡¨å•
                document.getElementById('balanceForm').reset();
                document.getElementById('balanceOperation').value = 'add';
                
                modal.show();
            }

            async executeBalanceOperation() {
                try {
                    const operation = document.getElementById('balanceOperation').value;
                    const amount = parseFloat(document.getElementById('balanceAmount').value);
                    const note = document.getElementById('balanceNote').value.trim();
                    
                    if (!amount || amount <= 0) {
                        this.showError('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢?);
                        return;
                    }
                    
                    console.log('ğŸ’° å¼€å§‹æ‰§è¡Œä½™é¢æ“ä½?', {
                        userId: this.currentUser.id,
                        operation,
                        amount,
                        note
                    });

                    // æ¨¡æ‹ŸAPIè°ƒç”¨
                    const success = await this.simulateBalanceOperation(this.currentUser.id, operation, amount, note);
                    
                    if (success) {
                        // å…³é—­æ¨¡æ€æ¡†
                        const modal = bootstrap.Modal.getInstance(document.getElementById('balanceModal'));
                        if (modal) {
                            modal.hide();
                        }

                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        this.updateUserBalance(this.currentUser.id, operation, amount);
                        
                        // é‡æ–°æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
                        this.renderUsers();
                        
                        this.showSuccess('ä½™é¢æ“ä½œæ‰§è¡ŒæˆåŠŸ');
                    } else {
                        this.showError('ä½™é¢æ“ä½œå¤±è´¥');
                    }
                } catch (error) {
                    console.error('â?ä½™é¢æ“ä½œå¤±è´¥:', error);
                    this.showError('æ“ä½œå¤±è´¥: ' + error.message);
                }
            }

            async simulateBalanceOperation(userId, operation, amount, note) {
                // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ¨¡æ‹ŸæˆåŠŸå“åº”
                console.log('âœ?æ¨¡æ‹Ÿä½™é¢æ“ä½œæˆåŠŸ:', { userId, operation, amount, note });
                return true;
            }

            updateUserBalance(userId, operation, amount) {
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    switch (operation) {
                        case 'add':
                            user.balance += amount;
                            break;
                        case 'subtract':
                            user.balance = Math.max(0, user.balance - amount);
                            break;
                        case 'freeze':
                            // è¿™é‡Œå¯ä»¥æ·»åŠ å†»ç»“é€»è¾‘
                            break;
                        case 'unfreeze':
                            // è¿™é‡Œå¯ä»¥æ·»åŠ è§£å†»é€»è¾‘
                            break;
                    }
                    console.log('ğŸ“Š ç”¨æˆ·ä½™é¢å·²æ›´æ–?', user);
                }
            }

            showSuccess(message) {
                alert('âœ?' + message);
            }

            showError(message) {
                alert('â?' + message);
            }
        }

        // åˆå§‹åŒ–åº”ç”?
        document.addEventListener('DOMContentLoaded', () => {
            window.userBalanceTest = new UserBalanceTest();
        });
    </script>
</body>
</html>
