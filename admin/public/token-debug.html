<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Tokenè°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .token-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Tokenè°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1. å½“å‰TokençŠ¶æ€</h2>
        <button onclick="checkTokenStatus()">æ£€æŸ¥TokençŠ¶æ€</button>
        <button onclick="clearTokens()" class="danger">æ¸…é™¤æ‰€æœ‰Token</button>
        <div id="tokenStatus"></div>
    </div>

    <div class="debug-section">
        <h2>2. æ¨¡æ‹Ÿç™»å½•</h2>
        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="testUsername" value="superadmin">
        </div>
        <div class="form-group">
            <label>å¯†ç :</label>
            <input type="password" id="testPassword" value="admin123">
        </div>
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <button onclick="testLogout()">æµ‹è¯•ç™»å‡º</button>
    </div>

    <div class="debug-section">
        <h2>3. Tokenç›‘æ§</h2>
        <button onclick="startTokenMonitoring()">å¼€å§‹ç›‘æ§</button>
        <button onclick="stopTokenMonitoring()">åœæ­¢ç›‘æ§</button>
        <div id="tokenMonitor" class="log-output"></div>
    </div>

    <div class="debug-section">
        <h2>4. é¡µé¢åˆ·æ–°æµ‹è¯•</h2>
        <button onclick="testPageRefresh()">æµ‹è¯•é¡µé¢åˆ·æ–°</button>
        <button onclick="simulateAppInit()">æ¨¡æ‹ŸAppåˆå§‹åŒ–</button>
        <div id="refreshTest" class="log-output"></div>
    </div>

    <div class="debug-section">
        <h2>5. å®æ—¶çŠ¶æ€</h2>
        <div id="realTimeStatus"></div>
    </div>

    <script>
        let tokenMonitoring = false;
        let monitoringInterval = null;

        // æ£€æŸ¥TokençŠ¶æ€
        function checkTokenStatus() {
            const output = document.getElementById('tokenStatus');
            let status = '<h3>TokençŠ¶æ€æ£€æŸ¥ç»“æœ</h3>';
            
            try {
                const adminToken = localStorage.getItem('adminToken');
                const adminUser = localStorage.getItem('adminUser');
                
                if (adminToken) {
                    status += '<div><span class="status-indicator status-success"></span>adminTokenå­˜åœ¨</div>';
                    status += `<div class="token-info">Tokenï¼š${adminToken.substring(0, 50)}...</div>`;
                    
                    // è§£æJWT Token
                    if (adminToken.includes('.')) {
                        try {
                            const parts = adminToken.split('.');
                            if (parts.length === 3) {
                                const payload = JSON.parse(atob(parts[1]));
                                status += '<div><span class="status-indicator status-info"></span>JWT Tokenè§£ææˆåŠŸ</div>';
                                status += `<div class="token-info">Payload: ${JSON.stringify(payload, null, 2)}</div>`;
                                
                                // æ£€æŸ¥è¿‡æœŸæ—¶é—´
                                if (payload.exp) {
                                    const expDate = new Date(payload.exp * 1000);
                                    const now = new Date();
                                    if (expDate > now) {
                                        status += `<div><span class="status-indicator status-success"></span>Tokenæœªè¿‡æœŸ(è¿‡æœŸæ—¶é—´: ${expDate.toLocaleString()})</div>`;
                                    } else {
                                        status += `<div><span class="status-indicator status-error"></span>Tokenå·²è¿‡æœŸ(è¿‡æœŸæ—¶é—´: ${expDate.toLocaleString()})</div>`;
                                    }
                                }
                            }
                        } catch (e) {
                            status += `<div><span class="status-indicator status-error"></span>JWTè§£æå¤±è´¥: ${e.message}</div>`;
                        }
                    } else {
                        status += '<div><span class="status-indicator status-warning"></span>éJWTæ ¼å¼Token</div>';
                    }
                } else {
                    status += '<div><span class="status-indicator status-error"></span>adminTokenä¸å­˜åœ¨</div>';
                }
                
                if (adminUser) {
                    status += '<div><span class="status-indicator status-success"></span>adminUserå­˜åœ¨</div>';
                    try {
                        const user = JSON.parse(adminUser);
                        status += `<div class="token-info">ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(user, null, 2)}</div>`;
                    } catch (e) {
                        status += `<div><span class="status-indicator status-error"></span>ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥: ${e.message}</div>`;
                    }
                } else {
                    status += '<div><span class="status-indicator status-error"></span>adminUserä¸å­˜åœ¨</div>';
                }
                
                // æ£€æŸ¥å…¶ä»–ç›¸å…³å­˜å‚¨
                const allKeys = Object.keys(localStorage);
                const adminKeys = allKeys.filter(key => key.includes('admin'));
                status += `<div><span class="status-indicator status-info"></span>æ‰€æœ‰adminç›¸å…³é”®: ${adminKeys.join(', ')}</div>`;
                
            } catch (error) {
                status += `<div><span class="status-indicator status-error"></span>æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
            
            output.innerHTML = status;
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                const response = await fetch('http://localhost:3000/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    const adminToken = result.data.token;
                    const adminUser = result.data.admin;
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('adminToken', adminToken);
                    localStorage.setItem('adminUser', JSON.stringify(adminUser));
                    
                    alert('âœ…æµ‹è¯•ç™»å½•æˆåŠŸï¼Tokenå·²ä¿å­˜');
                    checkTokenStatus();
                } else {
                    alert(`âŒæµ‹è¯•ç™»å½•å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                alert(`ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•ç™»å‡º
        function testLogout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            alert('âœ…æµ‹è¯•ç™»å‡ºå®Œæˆï¼Tokenå·²æ¸…é™¤');
            checkTokenStatus();
        }

        // æ¸…é™¤æ‰€æœ‰Token
        function clearTokens() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰Tokenå—ï¼Ÿ')) {
                const allKeys = Object.keys(localStorage);
                allKeys.forEach(key => {
                    if (key.includes('admin') || key.includes('token')) {
                        localStorage.removeItem(key);
                    }
                });
                alert('âœ…æ‰€æœ‰Tokenå·²æ¸…é™¤');
                checkTokenStatus();
            }
        }

        // å¼€å§‹Tokenç›‘æ§
        function startTokenMonitoring() {
            tokenMonitoring = true;
            const output = document.getElementById('tokenMonitor');
            output.textContent = 'å¼€å§‹ç›‘æ§Tokenå˜åŒ–...\n';
            
            // ç›‘æ§localStorageå˜åŒ–
            const originalSetItem = localStorage.setItem;
            const originalRemoveItem = localStorage.removeItem;
            
            localStorage.setItem = function(key, value) {
                if (tokenMonitoring && (key === 'adminToken' || key === 'adminUser')) {
                    const timestamp = new Date().toLocaleTimeString();
                    output.textContent += `[${timestamp}] SET ${key}: ${value.substring(0, 50)}...\n`;
                    output.scrollTop = output.scrollHeight;
                }
                originalSetItem.apply(this, arguments);
            };
            
            localStorage.removeItem = function(key) {
                if (tokenMonitoring && (key === 'adminToken' || key === 'adminUser')) {
                    const timestamp = new Date().toLocaleTimeString();
                    output.textContent += `[${timestamp}] REMOVE ${key}\n`;
                    output.scrollTop = output.scrollHeight;
                }
                originalRemoveItem.apply(this, arguments);
            };
            
            // å®šæœŸæ£€æŸ¥TokençŠ¶æ€
            monitoringInterval = setInterval(() => {
                const adminToken = localStorage.getItem('adminToken');
                const adminUser = localStorage.getItem('adminUser');
                const timestamp = new Date().toLocaleTimeString();
                
                if (adminToken && adminUser) {
                    output.textContent += `[${timestamp}] âœ… TokençŠ¶æ€æ­£å¸¸\n`;
                } else {
                    output.textContent += `[${timestamp}] âŒ TokençŠ¶æ€å¼‚å¸¸\n`;
                }
                output.scrollTop = output.scrollHeight;
            }, 5000);
            
            alert('âœ… Tokenç›‘æ§å·²å¼€å¯');
        }

        // åœæ­¢Tokenç›‘æ§
        function stopTokenMonitoring() {
            tokenMonitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            alert('â¹ï¸ Tokenç›‘æ§å·²åœæ­¢');
        }

        // æµ‹è¯•é¡µé¢åˆ·æ–°
        function testPageRefresh() {
            const output = document.getElementById('refreshTest');
            output.textContent = 'å¼€å§‹é¡µé¢åˆ·æ–°æµ‹è¯•..\n';
            
            // æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°å‰çš„çŠ¶æ€
            const adminToken = localStorage.getItem('adminToken');
            const adminUser = localStorage.getItem('adminUser');
            
            output.textContent += `åˆ·æ–°å‰ - adminToken: ${adminToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            output.textContent += `åˆ·æ–°å‰ - adminUser: ${adminUser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            
            // æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°
            setTimeout(() => {
                output.textContent += 'æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°...\n';
                
                // æ£€æŸ¥åˆ·æ–°åçš„çŠ¶æ€
                const newAdminToken = localStorage.getItem('adminToken');
                const newAdminUser = localStorage.getItem('adminUser');
                
                output.textContent += `åˆ·æ–°å - adminToken: ${newAdminToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
                output.textContent += `åˆ·æ–°å - adminUser: ${newAdminUser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
                
                if (newAdminToken && newAdminUser) {
                    output.textContent += 'âœ…é¡µé¢åˆ·æ–°åTokençŠ¶æ€æ­£å¸¸\n';
                } else {
                    output.textContent += 'âŒé¡µé¢åˆ·æ–°åTokençŠ¶æ€å¼‚å¸¸\n';
                }
            }, 1000);
        }

        // æ¨¡æ‹ŸAppåˆå§‹åŒ–
        function simulateAppInit() {
            const output = document.getElementById('refreshTest');
            output.textContent = 'æ¨¡æ‹ŸAppåˆå§‹åŒ–..\n';
            
            // æ¨¡æ‹ŸcheckAuthStatusæ–¹æ³•
            const adminToken = localStorage.getItem('adminToken');
            const adminUser = localStorage.getItem('adminUser');
            
            output.textContent += `æ£€æŸ¥è®¤è¯çŠ¶æ€..\n`;
            output.textContent += `adminToken: ${adminToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            output.textContent += `adminUser: ${adminUser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            
            if (adminToken && adminUser) {
                try {
                    const user = JSON.parse(adminUser);
                    
                    // å¤„ç†JWTæ ¼å¼token
                    let tokenData;
                    if (adminToken.includes('.')) {
                        const parts = adminToken.split('.');
                        if (parts.length === 3) {
                            try {
                                tokenData = JSON.parse(atob(parts[1]));
                                output.textContent += 'JWT Tokenè§£ææˆåŠŸ\n';
                                
                                if (tokenData.exp) {
                                    const expTime = tokenData.exp * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
                                    const now = Date.now();
                                    output.textContent += `Tokenè¿‡æœŸæ—¶é—´: ${new Date(expTime).toLocaleString()}\n`;
                                    output.textContent += `å½“å‰æ—¶é—´: ${new Date(now).toLocaleString()}\n`;
                                    output.textContent += `å‰©ä½™æ—¶é—´: ${Math.floor((expTime - now) / 1000)} ç§’\n`;
                                    
                                    if (expTime > now) {
                                        output.textContent += 'âœ…Tokenæœªè¿‡æœŸï¼Œè®¤è¯æˆåŠŸ\n';
                                    } else {
                                        output.textContent += 'âŒTokenå·²è¿‡æœŸï¼Œè®¤è¯å¤±è´¥\n';
                                    }
                                } else {
                                    output.textContent += 'âš ï¸ Tokenæ²¡æœ‰è¿‡æœŸæ—¶é—´å­—æ®µ\n';
                                }
                            } catch (e) {
                                output.textContent += `âŒJWTè§£æå¤±è´¥: ${e.message}\n`;
                            }
                        }
                    } else {
                        output.textContent += 'éJWTæ ¼å¼Token\n';
                    }
                } catch (error) {
                    output.textContent += `âŒç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥: ${error.message}\n`;
                }
            } else {
                output.textContent += 'âŒè®¤è¯ä¿¡æ¯ä¸å®Œæ•´\n';
            }
        }

        // å®æ—¶çŠ¶æ€æ›´æ–°
        function updateRealTimeStatus() {
            const output = document.getElementById('realTimeStatus');
            const adminToken = localStorage.getItem('adminToken');
            const adminUser = localStorage.getItem('adminUser');
            
            let status = '<h3>å®æ—¶çŠ¶æ€</h3>';
            status += `<div>adminToken: <span style="color: ${adminToken ? 'green' : 'red'}">${adminToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</span></div>`;
            status += `<div>adminUser: <span style="color: ${adminUser ? 'green' : 'red'}">${adminUser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</span></div>`;
            
            if (adminToken && adminUser) {
                try {
                    const user = JSON.parse(adminUser);
                    status += `<div>ç”¨æˆ·å: ${user.username || 'æœªçŸ¥'}</div>`;
                } catch (e) {
                    status += `<div>ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥</div>`;
                }
            }
            
            status += `<div>å½“å‰æ—¶é—´: ${new Date().toLocaleString()}</div>`;
            
            output.innerHTML = status;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            checkTokenStatus();
            updateRealTimeStatus();
            
            // æ¯ç§’æ›´æ–°å®æ—¶çŠ¶æ€
            setInterval(updateRealTimeStatus, 1000);
        });

        // ç¼–ç /å†…å®¹æŸåè‡ªæ£€ä¸ä¿æŠ¤
        (function encodingGuard() {
            try {
                const html = document.documentElement ? document.documentElement.innerHTML : '';
                const hasBroken = /çŠ¶ï¿½\?|åˆå§‹ï¿½\?|ç›‘ï¿½\?|ä¸å­˜ï¿½\?|æ¯«ï¿½\?|æ—¶é—´ï¿½\?|æµ‹ï¿½\?/u.test(html);
                if (hasBroken) {
                    const banner = document.createElement('div');
                    banner.setAttribute('style', 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#dc3545;color:#fff;padding:10px 16px;font-weight:bold;');
                    banner.textContent = 'è­¦å‘Šï¼šé¡µé¢åŒ…å«ç–‘ä¼¼ç¼–ç æˆ–å†…å®¹æŸåï¼ˆå·²ç¦ç”¨äº¤äº’æŒ‰é’®ï¼‰ï¼Œè¯·ä»¥ UTF-8 é‡æ–°ä¿å­˜ååˆ·æ–°ã€‚';
                    document.body.prepend(banner);
                    const buttons = document.querySelectorAll('button');
                    buttons.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed'; });
                }
            } catch (_) { /* ignore */ }
        })();
    </script>
</body>
</html>
