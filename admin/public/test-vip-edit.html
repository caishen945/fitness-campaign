<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPç¼–è¾‘åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 5px; width: 80%; max-width: 500px; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ”§ VIPç¼–è¾‘åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="status info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•VIPç­‰çº§ç¼–è¾‘åŠŸèƒ½ï¼?/p>
        <ul>
            <li>âœ?è·å–VIPç­‰çº§åˆ—è¡¨</li>
            <li>âœ?ç¼–è¾‘VIPç­‰çº§ä¿¡æ¯</li>
            <li>âœ?éªŒè¯æ•°æ®ä¿å­˜</li>
            <li>âœ?é”™è¯¯å¤„ç†æµ‹è¯•</li>
        </ul>
    </div>
    
    <div id="testResults"></div>
    
    <div style="margin: 20px 0;">
        <button class="btn-primary" onclick="loadVipLevels()">åŠ è½½VIPç­‰çº§</button>
        <button class="btn-success" onclick="testEditVip()">æµ‹è¯•ç¼–è¾‘VIP</button>
        <button class="btn-danger" onclick="testDuplicateName()">æµ‹è¯•é‡å¤åç§°</button>
        <button class="btn-primary" onclick="showEditModal()">æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†</button>
    </div>
    
    <!-- VIPç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="vipEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>ç¼–è¾‘VIPç­‰çº§</h2>
            <form id="vipEditForm">
                <div class="form-group">
                    <label for="levelName">ç­‰çº§åç§°:</label>
                    <input type="text" id="levelName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="stepGoal">æ¯æ—¥ç›®æ ‡æ­¥æ•°:</label>
                    <input type="number" id="stepGoal" name="step_goal" required>
                </div>
                <div class="form-group">
                    <label for="deposit">æŠ¼é‡‘é‡‘é¢:</label>
                    <input type="number" id="deposit" name="deposit" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="reward">æ¯æ—¥å¥–åŠ±:</label>
                    <input type="number" id="reward" name="reward" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="challengeTimes">æŒ‘æˆ˜æ¬¡æ•°:</label>
                    <input type="number" id="challengeTimes" name="challenge_times" required>
                </div>
                <div class="form-group">
                    <label for="levelColor">ç­‰çº§é¢œè‰²:</label>
                    <input type="color" id="levelColor" name="color" value="#FFD700">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isActive" name="is_active" checked>
                        å¯ç”¨çŠ¶æ€?
                    </label>
                </div>
                <button type="submit" class="btn-success">ä¿å­˜</button>
                <button type="button" class="btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>
    
    <script>
        let vipLevels = [];
        let currentEditLevel = null;
        
        async function loadVipLevels() {
            let html = '<h3>ğŸ† VIPç­‰çº§åˆ—è¡¨</h3>';
            
            try {
                const response = await fetch('http://localhost:3000/api/admin/vip-levels', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    vipLevels = result.data;
                    html += '<div class="status success">âœ?VIPç­‰çº§åŠ è½½æˆåŠŸ</div>';
                    html += `<div class="status info">å…?${vipLevels.length} ä¸ªç­‰çº?/div>`;
                    
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<tr style="background: #f8f9fa;"><th style="padding: 10px; text-align: left;">ID</th><th style="padding: 10px; text-align: left;">åç§°</th><th style="padding: 10px; text-align: left;">æŠ¼é‡‘</th><th style="padding: 10px; text-align: left;">å¥–åŠ±</th><th style="padding: 10px; text-align: left;">æ“ä½œ</th></tr>';
                    
                    vipLevels.forEach(level => {
                        html += `<tr style="border-bottom: 1px solid #ddd;">`;
                        html += `<td style="padding: 10px;">${level.id}</td>`;
                        html += `<td style="padding: 10px;">${level.name || level.level_name || 'æœªçŸ¥'}</td>`;
                        html += `<td style="padding: 10px;">${level.deposit_amount || level.deposit || 0}</td>`;
                        html += `<td style="padding: 10px;">${level.reward_amount || level.reward || 0}</td>`;
                        html += `<td style="padding: 10px;"><button onclick="editLevel(${level.id})" class="btn-primary">ç¼–è¾‘</button></td>`;
                        html += `</tr>`;
                    });
                    
                    html += '</table>';
                } else {
                    html += '<div class="status error">â?VIPç­‰çº§åŠ è½½å¤±è´¥</div>';
                    html += `<div class="status error">é”™è¯¯ä¿¡æ¯: ${result.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                html += '<div class="status error">â?VIPç­‰çº§åŠ è½½å¤±è´¥</div>';
                html += `<div class="status error">é”™è¯¯: ${error.message}</div>`;
            }
            
            document.getElementById('testResults').innerHTML = html;
        }
        
        function editLevel(levelId) {
            const level = vipLevels.find(l => l.id == levelId);
            if (level) {
                currentEditLevel = level;
                showEditModal();
                populateForm(level);
            }
        }
        
        function populateForm(level) {
            document.getElementById('levelName').value = level.name || level.level_name || '';
            document.getElementById('stepGoal').value = level.step_target || level.step_goal || level.stepGoal || '';
            document.getElementById('deposit').value = level.deposit_amount || level.deposit || '';
            document.getElementById('reward').value = level.reward_amount || level.reward || '';
            document.getElementById('challengeTimes').value = level.challenge_times || level.challengeTimes || '';
            document.getElementById('levelColor').value = level.color || '#FFD700';
            document.getElementById('isActive').checked = level.is_active !== false && level.isActive !== false;
        }
        
        function showEditModal() {
            document.getElementById('vipEditModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('vipEditModal').style.display = 'none';
            currentEditLevel = null;
            document.getElementById('vipEditForm').reset();
        }
        
        async function testEditVip() {
            if (vipLevels.length === 0) {
                alert('è¯·å…ˆåŠ è½½VIPç­‰çº§åˆ—è¡¨');
                return;
            }
            
            const level = vipLevels[0];
            const testData = {
                name: level.name + '_TEST_' + Date.now(),
                step_goal: 10000,
                deposit: 100.0,
                reward: 10.0,
                challenge_times: 3,
                color: '#FF0000',
                is_active: true
            };
            
            let html = '<h3>ğŸ”§ VIPç¼–è¾‘æµ‹è¯•</h3>';
            
            try {
                const response = await fetch(`http://localhost:3000/api/admin/vip-levels/${level.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    html += '<div class="status success">âœ?VIPç¼–è¾‘æµ‹è¯•æˆåŠŸ</div>';
                    html += '<div class="status info">æµ‹è¯•æ•°æ®:</div>';
                    html += `<div class="status info" style="font-family: monospace; font-size: 12px;">`;
                    html += JSON.stringify(testData, null, 2);
                    html += '</div>';
                } else {
                    html += '<div class="status error">â?VIPç¼–è¾‘æµ‹è¯•å¤±è´¥</div>';
                    html += `<div class="status error">é”™è¯¯ä¿¡æ¯: ${result.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                html += '<div class="status error">â?VIPç¼–è¾‘æµ‹è¯•å¤±è´¥</div>';
                html += `<div class="status error">é”™è¯¯: ${error.message}</div>`;
            }
            
            document.getElementById('testResults').innerHTML = html;
        }
        
        async function testDuplicateName() {
            if (vipLevels.length === 0) {
                alert('è¯·å…ˆåŠ è½½VIPç­‰çº§åˆ—è¡¨');
                return;
            }
            
            const level = vipLevels[0];
            const testData = {
                name: level.name, // ä½¿ç”¨ç›¸åŒçš„åç§?
                step_goal: 10000,
                deposit: 100.0,
                reward: 10.0,
                challenge_times: 3,
                color: '#FF0000',
                is_active: true
            };
            
            let html = '<h3>ğŸ”§ é‡å¤åç§°æµ‹è¯•</h3>';
            
            try {
                const response = await fetch(`http://localhost:3000/api/admin/vip-levels/${level.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (response.status === 400 && result.message.includes('å·²å­˜åœ?)) {
                    html += '<div class="status success">âœ?é‡å¤åç§°æ£€æµ‹æ­£å¸?/div>';
                    html += `<div class="status info">é”™è¯¯ä¿¡æ¯: ${result.message}</div>`;
                } else {
                    html += '<div class="status warning">âš ï¸ é‡å¤åç§°æ£€æµ‹å¯èƒ½æœ‰é—®é¢˜</div>';
                    html += `<div class="status info">å“åº”: ${JSON.stringify(result)}</div>`;
                }
            } catch (error) {
                html += '<div class="status error">â?é‡å¤åç§°æµ‹è¯•å¤±è´¥</div>';
                html += `<div class="status error">é”™è¯¯: ${error.message}</div>`;
            }
            
            document.getElementById('testResults').innerHTML = html;
        }
        
        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('vipEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('levelName').value,
                step_goal: parseInt(document.getElementById('stepGoal').value),
                deposit: parseFloat(document.getElementById('deposit').value),
                reward: parseFloat(document.getElementById('reward').value),
                challenge_times: parseInt(document.getElementById('challengeTimes').value),
                color: document.getElementById('levelColor').value,
                is_active: document.getElementById('isActive').checked
            };
            
            let html = '<h3>ğŸ’¾ ä¿å­˜VIPç­‰çº§</h3>';
            
            try {
                const url = currentEditLevel 
                    ? `http://localhost:3000/api/admin/vip-levels/${currentEditLevel.id}`
                    : 'http://localhost:3000/api/admin/vip-levels';
                
                const method = currentEditLevel ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    html += '<div class="status success">âœ?VIPç­‰çº§ä¿å­˜æˆåŠŸ</div>';
                    closeModal();
                    loadVipLevels(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    html += '<div class="status error">â?VIPç­‰çº§ä¿å­˜å¤±è´¥</div>';
                    html += `<div class="status error">é”™è¯¯ä¿¡æ¯: ${result.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                html += '<div class="status error">â?VIPç­‰çº§ä¿å­˜å¤±è´¥</div>';
                html += `<div class="status error">é”™è¯¯: ${error.message}</div>`;
            }
            
            document.getElementById('testResults').innerHTML = html;
        });
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½VIPç­‰çº§
        window.onload = loadVipLevels;
    </script>
</body>
</html>
