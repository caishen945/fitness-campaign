<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½®è¯Šæ–­å·¥å…·</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <style>
        .diagnostic-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3><i class="fas fa-stethoscope"></i> ç³»ç»Ÿè®¾ç½®è¯Šæ–­å·¥å…·</h3>
                        <p class="mb-0">è¯Šæ–­ä¸ºä»€ä¹ˆç³»ç»Ÿè®¾ç½®èœå•ä¼šæ¶ˆå¤±</p>
                    </div>
                    <div class="card-body">
                        
                        <div class="diagnostic-section">
                            <h5><i class="fas fa-info-circle"></i> é—®é¢˜è¯´æ˜</h5>
                            <div class="alert alert-info">
                                <strong>å‘ç°:</strong> ç³»ç»Ÿè®¾ç½®åŠŸèƒ½æœ¬èº«æ˜¯å®Œæ•´çš„ï¼ŒåŒ…æ‹¬SystemSettingsç±»ã€å¯¼èˆªé€»è¾‘ã€èœå•é…ç½®ç­‰ã€‚
                                é—®é¢˜åœ¨äºèœå•é¡¹åœ¨æŸäº›æƒ…å†µä¸‹ä¼šæ¶ˆå¤±æˆ–ç‚¹å‡»æ— æ•ˆã€‚
                            </div>
                        </div>

                        <div class="diagnostic-section">
                            <h5><i class="fas fa-play"></i> å¿«é€Ÿæ“ä½œ</h5>
                            <div class="btn-group" role="group">
                                <button id="run-diagnosis" class="btn btn-primary">
                                    <i class="fas fa-search"></i> è¿è¡Œå®Œæ•´è¯Šæ–­
                                </button>
                                <button id="force-show-menu" class="btn btn-warning">
                                    <i class="fas fa-eye"></i> å¼ºåˆ¶æ˜¾ç¤ºèœå•
                                </button>
                                <button id="test-navigation" class="btn btn-success">
                                    <i class="fas fa-compass"></i> æµ‹è¯•å¯¼èˆªåŠŸèƒ½
                                </button>
                                <button id="clear-logs" class="btn btn-secondary">
                                    <i class="fas fa-trash"></i> æ¸…é™¤æ—¥å¿—
                                </button>
                            </div>
                        </div>

                        <div class="diagnostic-section">
                            <h5><i class="fas fa-list-check"></i> è¯Šæ–­ç»“æœ</h5>
                            <div id="diagnosis-results">
                                <p class="text-muted">ç‚¹å‡»"è¿è¡Œå®Œæ•´è¯Šæ–­"å¼€å§‹æ£€æŸ¥...</p>
                            </div>
                        </div>

                        <div class="diagnostic-section">
                            <h5><i class="fas fa-terminal"></i> å®æ—¶æ—¥å¿—</h5>
                            <div id="log-output" class="log-output"></div>
                        </div>

                        <div class="diagnostic-section">
                            <h5><i class="fas fa-tools"></i> ä¿®å¤å»ºè®®</h5>
                            <div id="fix-suggestions" class="alert alert-secondary">
                                ç­‰å¾…è¯Šæ–­å®Œæˆåæ˜¾ç¤ºä¿®å¤å»ºè®®...
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#17a2b8',
                success: '#28a745',
                warning: '#ffc107',
                error: '#dc3545'
            };
            
            const logOutput = document.getElementById('log-output');
            logOutput.innerHTML += `<div style="color: ${colors[type] || '#6c757d'};">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateDiagnosisResult(item, status, message) {
            const resultsDiv = document.getElementById('diagnosis-results');
            const existingItem = document.getElementById(`result-${item}`);
            
            const statusClass = status === 'success' ? 'status-success' : 
                               status === 'warning' ? 'status-warning' : 'status-error';
            
            const resultHtml = `
                <div id="result-${item}" class="d-flex align-items-center mb-2">
                    <span class="status-indicator ${statusClass}"></span>
                    <strong>${item}:</strong> ${message}
                </div>
            `;
            
            if (existingItem) {
                existingItem.outerHTML = resultHtml;
            } else {
                resultsDiv.innerHTML += resultHtml;
            }
        }

        // è¿è¡Œå®Œæ•´è¯Šæ–­
        document.getElementById('run-diagnosis').addEventListener('click', async function() {
            log('ğŸ” å¼€å§‹è¿è¡Œå®Œæ•´ç³»ç»Ÿè®¾ç½®è¯Šæ–­...', 'info');
            
            const resultsDiv = document.getElementById('diagnosis-results');
            resultsDiv.innerHTML = '<p class="text-info">æ­£åœ¨è¯Šæ–­ä¸­...</p>';
            
            // 1. æ£€æŸ¥AdminAppæ˜¯å¦å­˜åœ¨
            log('ğŸ“‹ æ­¥éª¤1: æ£€æŸ¥AdminAppå®ä¾‹...', 'info');
            if (window.parent && window.parent.adminApp) {
                const adminApp = window.parent.adminApp;
                updateDiagnosisResult('AdminAppå®ä¾‹', 'success', 'å·²æ‰¾åˆ°');
                log('âœ… AdminAppå®ä¾‹å­˜åœ¨', 'success');
                
                // 2. æ£€æŸ¥è®¤è¯çŠ¶æ€
                log('ğŸ“‹ æ­¥éª¤2: æ£€æŸ¥è®¤è¯çŠ¶æ€...', 'info');
                if (adminApp.isAuthenticated) {
                    updateDiagnosisResult('è®¤è¯çŠ¶æ€', 'success', 'å·²è®¤è¯');
                    log('âœ… ç”¨æˆ·å·²è®¤è¯', 'success');
                } else {
                    updateDiagnosisResult('è®¤è¯çŠ¶æ€', 'error', 'æœªè®¤è¯ - è¿™å¯èƒ½æ˜¯èœå•æ¶ˆå¤±çš„åŸå› ');
                    log('âŒ ç”¨æˆ·æœªè®¤è¯ï¼Œä¾§è¾¹æ ä¸ä¼šæ˜¾ç¤º', 'error');
                }
                
                // 3. æ£€æŸ¥pagesé…ç½®
                log('ğŸ“‹ æ­¥éª¤3: æ£€æŸ¥settingsé¡µé¢é…ç½®...', 'info');
                if (adminApp.pages && adminApp.pages.settings) {
                    const settingsConfig = adminApp.pages.settings;
                    updateDiagnosisResult('settingsé¡µé¢é…ç½®', 'success', 'é…ç½®å­˜åœ¨');
                    log('âœ… settingsé¡µé¢é…ç½®å­˜åœ¨', 'success');
                    
                    // æ£€æŸ¥å…·ä½“é…ç½®é¡¹
                    const hasClass = settingsConfig.Class;
                    const hasRender = typeof settingsConfig.render === 'function';
                    const hasAfterRender = typeof settingsConfig.afterRender === 'function';
                    
                    updateDiagnosisResult('SystemSettingsç±»', hasClass ? 'success' : 'error', 
                        hasClass ? 'å·²é…ç½®' : 'ç¼ºå¤±');
                    updateDiagnosisResult('renderæ–¹æ³•', hasRender ? 'success' : 'error', 
                        hasRender ? 'å·²é…ç½®' : 'ç¼ºå¤±');
                    updateDiagnosisResult('afterRenderæ–¹æ³•', hasAfterRender ? 'success' : 'error', 
                        hasAfterRender ? 'å·²é…ç½®' : 'ç¼ºå¤±');
                        
                    log(`   - SystemSettingsç±»: ${hasClass ? 'âœ…' : 'âŒ'}`, hasClass ? 'success' : 'error');
                    log(`   - renderæ–¹æ³•: ${hasRender ? 'âœ…' : 'âŒ'}`, hasRender ? 'success' : 'error');
                    log(`   - afterRenderæ–¹æ³•: ${hasAfterRender ? 'âœ…' : 'âŒ'}`, hasAfterRender ? 'success' : 'error');
                } else {
                    updateDiagnosisResult('settingsé¡µé¢é…ç½®', 'error', 'é…ç½®ç¼ºå¤±');
                    log('âŒ settingsé¡µé¢é…ç½®ç¼ºå¤±', 'error');
                }
                
                // 4. æ£€æŸ¥èœå•DOMå…ƒç´ 
                log('ğŸ“‹ æ­¥éª¤4: æ£€æŸ¥DOMä¸­çš„èœå•å…ƒç´ ...', 'info');
                const parentDoc = window.parent.document;
                const settingsLink = parentDoc.querySelector('[data-page="settings"]');
                
                if (settingsLink) {
                    updateDiagnosisResult('èœå•DOMå…ƒç´ ', 'success', 'å…ƒç´ å­˜åœ¨');
                    log('âœ… ç³»ç»Ÿè®¾ç½®èœå•DOMå…ƒç´ å­˜åœ¨', 'success');
                    
                    // æ£€æŸ¥æ ·å¼
                    const isVisible = settingsLink.offsetParent !== null;
                    const computedStyle = window.parent.getComputedStyle(settingsLink);
                    
                    updateDiagnosisResult('èœå•å¯è§æ€§', isVisible ? 'success' : 'warning', 
                        isVisible ? 'å¯è§' : 'éšè—');
                    log(`   - å¯è§æ€§: ${isVisible ? 'âœ…' : 'âš ï¸'}`, isVisible ? 'success' : 'warning');
                    log(`   - display: ${computedStyle.display}`, 'info');
                    log(`   - visibility: ${computedStyle.visibility}`, 'info');
                } else {
                    updateDiagnosisResult('èœå•DOMå…ƒç´ ', 'error', 'å…ƒç´ ä¸å­˜åœ¨');
                    log('âŒ ç³»ç»Ÿè®¾ç½®èœå•DOMå…ƒç´ ä¸å­˜åœ¨', 'error');
                }
                
                // 5. æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
                log('ğŸ“‹ æ­¥éª¤5: æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨...', 'info');
                if (typeof adminApp.navigate === 'function') {
                    updateDiagnosisResult('å¯¼èˆªåŠŸèƒ½', 'success', 'navigateæ–¹æ³•å­˜åœ¨');
                    log('âœ… navigateæ–¹æ³•å­˜åœ¨', 'success');
                } else {
                    updateDiagnosisResult('å¯¼èˆªåŠŸèƒ½', 'error', 'navigateæ–¹æ³•ç¼ºå¤±');
                    log('âŒ navigateæ–¹æ³•ç¼ºå¤±', 'error');
                }
                
            } else {
                updateDiagnosisResult('AdminAppå®ä¾‹', 'error', 'æœªæ‰¾åˆ°');
                log('âŒ æœªæ‰¾åˆ°AdminAppå®ä¾‹', 'error');
                log('ğŸ’¡ è¿™å¯èƒ½æ˜¯å› ä¸ºæ­¤é¡µé¢ä¸åœ¨ç®¡ç†å‘˜åå°æ¡†æ¶ä¸­æ‰“å¼€', 'warning');
            }
            
            // ç”Ÿæˆä¿®å¤å»ºè®®
            generateFixSuggestions();
            log('ğŸ¯ è¯Šæ–­å®Œæˆ', 'success');
        });

        // å¼ºåˆ¶æ˜¾ç¤ºèœå•
        document.getElementById('force-show-menu').addEventListener('click', function() {
            log('ğŸ”§ å°è¯•å¼ºåˆ¶æ˜¾ç¤ºç³»ç»Ÿè®¾ç½®èœå•...', 'info');
            
            if (window.parent && window.parent.document) {
                const parentDoc = window.parent.document;
                let settingsLink = parentDoc.querySelector('[data-page="settings"]');
                
                if (settingsLink) {
                    // å¼ºåˆ¶æ˜¾ç¤ºç°æœ‰èœå•
                    settingsLink.style.display = 'block';
                    settingsLink.style.visibility = 'visible';
                    settingsLink.style.opacity = '1';
                    const parent = settingsLink.closest('li');
                    if (parent) {
                        parent.style.display = 'block';
                        parent.style.visibility = 'visible';
                    }
                    log('âœ… å·²å¼ºåˆ¶æ˜¾ç¤ºç°æœ‰çš„ç³»ç»Ÿè®¾ç½®èœå•', 'success');
                } else {
                    // åˆ›å»ºæ–°çš„èœå•é¡¹
                    const sidebar = parentDoc.querySelector('.sidebar');
                    if (sidebar) {
                        const navLinks = sidebar.querySelector('ul, .nav-links');
                        if (navLinks) {
                            const settingsLi = parentDoc.createElement('li');
                            settingsLi.style.marginBottom = '0.5rem';
                            settingsLi.innerHTML = `
                                <a href="#" data-page="settings" style="color: white; text-decoration: none; padding: 0.75rem 1.5rem; display: block; border-left: 4px solid transparent; background: transparent; transition: all 0.3s ease;">
                                    <i class="fas fa-cogs" style="margin-right: 10px;"></i> ç³»ç»Ÿè®¾ç½®
                                    <small style="float: right; opacity: 0.7;">Ctrl+9</small>
                                </a>
                            `;
                            navLinks.appendChild(settingsLi);
                            log('âœ… å·²åˆ›å»ºæ–°çš„ç³»ç»Ÿè®¾ç½®èœå•é¡¹', 'success');
                        } else {
                            log('âŒ æœªæ‰¾åˆ°å¯¼èˆªé“¾æ¥å®¹å™¨', 'error');
                        }
                    } else {
                        log('âŒ æœªæ‰¾åˆ°ä¾§è¾¹æ ', 'error');
                    }
                }
            } else {
                log('âŒ æ— æ³•è®¿é—®çˆ¶é¡µé¢æ–‡æ¡£', 'error');
            }
        });

        // æµ‹è¯•å¯¼èˆªåŠŸèƒ½
        document.getElementById('test-navigation').addEventListener('click', function() {
            log('ğŸ§ª æµ‹è¯•ç³»ç»Ÿè®¾ç½®å¯¼èˆªåŠŸèƒ½...', 'info');
            
            if (window.parent && window.parent.adminApp) {
                const adminApp = window.parent.adminApp;
                
                try {
                    log('ğŸš€ è°ƒç”¨ adminApp.navigate("settings")', 'info');
                    log(`å½“å‰é¡µé¢: ${adminApp.currentPage}`, 'info');
                    log(`è®¤è¯çŠ¶æ€: ${adminApp.isAuthenticated}`, 'info');
                    
                    // æ£€æŸ¥pagesé…ç½®
                    if (adminApp.pages && adminApp.pages.settings) {
                        log('âœ… settingsé¡µé¢é…ç½®å­˜åœ¨', 'success');
                        log(`settingsé…ç½®:`, 'info');
                        log(`- Class: ${adminApp.pages.settings.Class ? adminApp.pages.settings.Class.name : 'undefined'}`, 'info');
                        log(`- render: ${typeof adminApp.pages.settings.render}`, 'info');
                        log(`- afterRender: ${typeof adminApp.pages.settings.afterRender}`, 'info');
                        log(`- instance: ${adminApp.pages.settings.instance ? 'exists' : 'null'}`, 'info');
                    } else {
                        log('âŒ settingsé¡µé¢é…ç½®ä¸å­˜åœ¨', 'error');
                    }
                    
                    // å°è¯•å¯¼èˆª
                    adminApp.navigate('settings');
                    log('âœ… å¯¼èˆªè°ƒç”¨æˆåŠŸ', 'success');
                    
                    // æ£€æŸ¥å¯¼èˆªåçš„çŠ¶æ€
                    setTimeout(() => {
                        log(`å¯¼èˆªåå½“å‰é¡µé¢: ${adminApp.currentPage}`, 'info');
                        const settingsLink = window.parent.document.querySelector('[data-page="settings"]');
                        if (settingsLink) {
                            log(`èœå•é¡¹ç±»å: ${settingsLink.className}`, 'info');
                            log(`èœå•é¡¹æ ·å¼: ${settingsLink.style.cssText}`, 'info');
                        }
                    }, 1000);
                    
                } catch (error) {
                    log(`âŒ å¯¼èˆªè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                }
            } else {
                log('âŒ AdminAppä¸å¯ç”¨', 'error');
            }
        });

        // æ¸…é™¤æ—¥å¿—
        document.getElementById('clear-logs').addEventListener('click', function() {
            document.getElementById('log-output').innerHTML = '';
            log('ğŸ§¹ æ—¥å¿—å·²æ¸…é™¤', 'info');
        });

        function generateFixSuggestions() {
            const suggestionsDiv = document.getElementById('fix-suggestions');
            const results = document.getElementById('diagnosis-results');
            
            let suggestions = [];
            
            // æ£€æŸ¥å…·ä½“é—®é¢˜å¹¶ç”Ÿæˆå»ºè®®
            if (results.innerHTML.includes('æœªè®¤è¯')) {
                suggestions.push('ğŸ”‘ <strong>è®¤è¯é—®é¢˜:</strong> è¯·ç¡®ä¿ç”¨æˆ·å·²ç™»å½•ç®¡ç†å‘˜åå°');
            }
            
            if (results.innerHTML.includes('å…ƒç´ ä¸å­˜åœ¨')) {
                suggestions.push('ğŸ¨ <strong>DOMé—®é¢˜:</strong> ç³»ç»Ÿè®¾ç½®èœå•é¡¹åœ¨DOMä¸­ç¼ºå¤±ï¼Œå¯èƒ½æ˜¯æ¸²æŸ“é—®é¢˜');
            }
            
            if (results.innerHTML.includes('é…ç½®ç¼ºå¤±')) {
                suggestions.push('âš™ï¸ <strong>é…ç½®é—®é¢˜:</strong> SystemSettingsé¡µé¢é…ç½®æœ‰é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥App-fixed.js');
            }
            
            if (suggestions.length === 0) {
                suggestions.push('âœ… <strong>ç³»ç»Ÿæ­£å¸¸:</strong> å¦‚æœä»æœ‰é—®é¢˜ï¼Œå°è¯•åˆ·æ–°é¡µé¢æˆ–æ¸…é™¤æµè§ˆå™¨ç¼“å­˜');
            }
            
            // æ·»åŠ é€šç”¨å»ºè®®
            suggestions.push('ğŸ’¡ <strong>é€šç”¨è§£å†³æ–¹æ¡ˆ:</strong>');
            suggestions.push('   â€¢ åˆ·æ–°ç®¡ç†å‘˜åå°é¡µé¢ (Ctrl+F5)');
            suggestions.push('   â€¢ ä½¿ç”¨é”®ç›˜å¿«æ·é”® Ctrl+9');
            suggestions.push('   â€¢ æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯');
            suggestions.push('   â€¢ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œæœ¬åœ°å­˜å‚¨');
            
            suggestionsDiv.innerHTML = suggestions.map(s => `<div>${s}</div>`).join('');
            suggestionsDiv.className = 'alert alert-info';
        }

        // é¡µé¢åŠ è½½æ—¶çš„æ¬¢è¿ä¿¡æ¯
        window.addEventListener('load', function() {
            log('ğŸ¯ ç³»ç»Ÿè®¾ç½®è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success');
            log('ğŸ’¡ è¿™ä¸ªå·¥å…·ä¼šå¸®åŠ©ä½ æ‰¾å‡ºç³»ç»Ÿè®¾ç½®èœå•æ¶ˆå¤±çš„åŸå› ', 'info');
            log('ğŸš€ ç‚¹å‡»"è¿è¡Œå®Œæ•´è¯Šæ–­"å¼€å§‹æ£€æŸ¥', 'info');
        });
    </script>
</body>
</html>
