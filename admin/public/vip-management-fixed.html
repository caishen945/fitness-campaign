<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPç®¡ç† - ä¿®å¤ç‰ˆæœ¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .vip-management-page { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { font-weight: bold; }
        .btn { margin: 2px; }
        .table th { background-color: #f8f9fa; font-weight: 600; }
        .modal-content { border-radius: 10px; }
        .form-control, .form-select { border-radius: 6px; }
    </style>
</head>
<body>
    <div class="vip-management-page">
        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
            <h1 style="color: #2c3e50; margin: 0 0 1rem 0;">VIPç­‰çº§ç®¡ç† - ä¿®å¤ç‰ˆæœ¬</h1>
            
            <!-- æ ‡ç­¾é¡µå¯¼èˆ?-->
            <div style="border-bottom: 2px solid #e9ecef; margin-bottom: 1.5rem;">
                <button class="tab-btn active" data-tab="levels" style="padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid #007bff; color: #007bff;">
                    VIPç­‰çº§ç®¡ç†
                </button>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="vip-management-content">
                <div id="loadingMessage" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸?..
                </div>
            </div>
        </div>
        
        <!-- VIPç­‰çº§ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div class="modal fade" id="levelModal" tabindex="-1" aria-labelledby="levelModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="levelModalLabel">æ·»åŠ VIPç­‰çº§</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="levelForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="levelName" class="form-label">ç­‰çº§åç§°</label>
                                        <input type="text" class="form-control" id="levelName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deposit" class="form-label">è§£é”é‡‘é¢ (USDT)</label>
                                        <input type="number" class="form-control" id="deposit" step="0.01" min="0" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="stepGoal" class="form-label">æ¯æ—¥ç›®æ ‡ (æ­¥æ•°)</label>
                                        <input type="number" class="form-control" id="stepGoal" min="0" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="dailyReward" class="form-label">æ¬¡æ—¥å¥–åŠ± (USDT)</label>
                                        <input type="number" class="form-control" id="dailyReward" step="0.01" min="0" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="challengeDays" class="form-label">æŒ‘æˆ˜å¤©æ•°</label>
                                        <input type="number" class="form-control" id="challengeDays" min="1" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="challengeTimes" class="form-label">æœ€å¤§æŒ‘æˆ˜æ¬¡æ•?/label>
                                        <input type="number" class="form-control" id="challengeTimes" min="1" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="maxFailedDays" class="form-label">æœ€å¤§å¤±è´¥å¤©æ•?/label>
                                        <input type="number" class="form-control" id="maxFailedDays" min="0" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="levelColor" class="form-label">ç­‰çº§é¢œè‰²</label>
                                        <input type="color" class="form-control" id="levelColor" value="#FFD700">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="levelDescription" class="form-label">ç­‰çº§æè¿°</label>
                                <textarea class="form-control" id="levelDescription" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isActive" checked>
                                    <label class="form-check-label" for="isActive">
                                        å¯ç”¨æ­¤ç­‰çº?
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" id="saveLevelBtn">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç®€åŒ–çš„VIPç®¡ç†ç±?
        class VIPManagementFixed {
            constructor() {
                this.vipLevels = [];
                this.currentLevel = null;
                this.init();
            }

            async init() {
                console.log('ğŸš€ VIPç®¡ç†ä¿®å¤ç‰ˆæœ¬åˆå§‹åŒ?..');
                await this.loadVipLevels();
                this.bindEvents();
            }

            async loadVipLevels() {
                try {
                    console.log('ğŸ“¡ å¼€å§‹åŠ è½½VIPç­‰çº§æ•°æ®...');
                    const response = await fetch('http://localhost:3000/api/admin/vip-levels', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('ğŸ“¥ APIå“åº”:', result);

                    if (result.success && result.data) {
                        this.vipLevels = result.data;
                        console.log('âœ?VIPç­‰çº§æ•°æ®åŠ è½½æˆåŠŸ:', this.vipLevels);
                        this.renderLevelsTable();
                    } else {
                        throw new Error(result.message || 'è·å–VIPç­‰çº§æ•°æ®å¤±è´¥');
                    }
                } catch (error) {
                    console.error('â?åŠ è½½VIPç­‰çº§æ•°æ®å¤±è´¥:', error);
                    this.showError('åŠ è½½VIPç­‰çº§æ•°æ®å¤±è´¥: ' + error.message);
                }
            }

            renderLevelsTable() {
                const container = document.querySelector('.vip-management-content');
                if (!container) {
                    console.error('â?æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´?);
                    return;
                }

                console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“VIPç­‰çº§è¡¨æ ¼...');
                console.log('ğŸ“Š å½“å‰VIPç­‰çº§æ•°æ®:', this.vipLevels);

                const html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #2c3e50; margin: 0;">VIPç­‰çº§åˆ—è¡¨</h2>
                        <button class="btn btn-primary" id="add-vip-level" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-plus"></i> æ·»åŠ VIPç­‰çº§
                        </button>
                    </div>
                    
                    <div class="vip-levels-table" style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">ç­‰çº§åç§°</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">è§£é”é‡‘é¢</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">æ¯æ—¥ç›®æ ‡</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">æ¬¡æ—¥å¥–åŠ±</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">æŒ‘æˆ˜å¤©æ•°</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">æœ€å¤§æŒ‘æˆ˜æ¬¡æ•?/th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">çŠ¶æ€?/th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.vipLevels.length > 0 ? this.vipLevels.map(level => {
                                    console.log('ğŸ” å¤„ç†VIPç­‰çº§æ•°æ®:', level);
                                    const name = level.name || 'æœªçŸ¥ç­‰çº§';
                                    const depositAmount = level.depositAmount || 0;
                                    const stepTarget = level.stepTarget || 0;
                                    const rewardAmount = level.dailyReward || 0;
                                    const challengeDays = level.duration || 0;
                                    const challengeTimes = level.maxChallenges || 0;
                                    const isActive = level.isActive !== false;
                                    const icon = level.icon || 'ğŸ¥‰';
                                    
                                    return `
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 1rem;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="font-size: 1.2rem;">${icon}</span>
                                                    <span>${name}</span>
                                                </div>
                                            </td>
                                            <td style="padding: 1rem;">${depositAmount} USDT</td>
                                            <td style="padding: 1rem;">${stepTarget} æ­?/td>
                                            <td style="padding: 1rem;">${rewardAmount} USDT</td>
                                            <td style="padding: 1rem;">${challengeDays} å¤?/td>
                                            <td style="padding: 1rem;">${challengeTimes} æ¬?/td>
                                            <td style="padding: 1rem;">
                                                <span style="color: ${isActive ? '#28a745' : '#dc3545'};">
                                                    ${isActive ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                                </span>
                                            </td>
                                            <td style="padding: 1rem;">
                                                <button class="btn btn-outline-primary edit-level" data-id="${level.id}" style="padding: 0.25rem 0.5rem; margin-right: 0.5rem;">
                                                    <i class="fas fa-edit"></i> ç¼–è¾‘
                                                </button>
                                                <button class="btn btn-outline-${isActive ? 'warning' : 'success'} toggle-status" data-id="${level.id}" data-active="${isActive}" style="padding: 0.25rem 0.5rem; margin-right: 0.5rem;">
                                                    ${isActive ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : `
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 2rem;">æš‚æ— VIPç­‰çº§æ•°æ®</td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = html;
                console.log('âœ?VIPç­‰çº§è¡¨æ ¼æ¸²æŸ“å®Œæˆ');
            }

            bindEvents() {
                // æ·»åŠ VIPç­‰çº§æŒ‰é’®
                document.getElementById('add-vip-level')?.addEventListener('click', () => {
                    this.showLevelModal();
                });

                // ç¼–è¾‘æŒ‰é’®
                document.querySelectorAll('.edit-level').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const levelId = parseInt(e.target.closest('.edit-level').getAttribute('data-id'));
                        const level = this.vipLevels.find(l => l.id === levelId);
                        if (level) {
                            this.showLevelModal(level);
                        }
                    });
                });

                // ä¿å­˜æŒ‰é’®
                document.getElementById('saveLevelBtn')?.addEventListener('click', () => {
                    this.saveLevelData();
                });
            }

            showLevelModal(level = null) {
                this.currentLevel = level;
                const modal = new bootstrap.Modal(document.getElementById('levelModal'));
                const modalTitle = document.getElementById('levelModalLabel');
                const form = document.getElementById('levelForm');
                
                if (level) {
                    modalTitle.textContent = 'ç¼–è¾‘VIPç­‰çº§';
                    document.getElementById('levelName').value = level.name || '';
                    document.getElementById('levelDescription').value = level.description || '';
                    document.getElementById('stepGoal').value = level.stepTarget || '';
                    document.getElementById('deposit').value = level.depositAmount || '';
                    document.getElementById('dailyReward').value = level.dailyReward || '';
                    document.getElementById('challengeDays').value = level.duration || '';
                    document.getElementById('challengeTimes').value = level.maxChallenges || '';
                    document.getElementById('maxFailedDays').value = level.maxFailedDays || '';
                    document.getElementById('levelColor').value = level.color || '#FFD700';
                    document.getElementById('isActive').checked = level.isActive !== false;
                } else {
                    modalTitle.textContent = 'æ·»åŠ VIPç­‰çº§';
                    form.reset();
                    document.getElementById('levelColor').value = '#FFD700';
                }
                
                modal.show();
            }

            async saveLevelData() {
                try {
                    const formData = {
                        name: document.getElementById('levelName').value,
                        description: document.getElementById('levelDescription').value,
                        stepTarget: parseInt(document.getElementById('stepGoal').value) || 0,
                        depositAmount: parseFloat(document.getElementById('deposit').value) || 0,
                        dailyReward: parseFloat(document.getElementById('dailyReward').value) || 0,
                        duration: parseInt(document.getElementById('challengeDays').value) || 1,
                        maxChallenges: parseInt(document.getElementById('challengeTimes').value) || 1,
                        maxFailedDays: parseInt(document.getElementById('maxFailedDays').value) || 3,
                        color: document.getElementById('levelColor').value,
                        isActive: document.getElementById('isActive').checked
                    };
                    
                    console.log('ğŸ“¤ å‘é€çš„formData:', formData);

                    const url = this.currentLevel 
                        ? `http://localhost:3000/api/admin/vip-levels/${this.currentLevel.id}`
                        : 'http://localhost:3000/api/admin/vip-levels';
                    
                    const method = this.currentLevel ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('ğŸ“¥ ä¿å­˜å“åº”:', result);

                    if (result.success) {
                        // å…³é—­æ¨¡æ€æ¡†
                        const modal = bootstrap.Modal.getInstance(document.getElementById('levelModal'));
                        if (modal) {
                            modal.hide();
                        }

                        // é‡æ–°åŠ è½½æ•°æ®
                        console.log('ğŸ”„ å¼€å§‹é‡æ–°åŠ è½½VIPç­‰çº§æ•°æ®...');
                        await this.loadVipLevels();
                        console.log('âœ?VIPç­‰çº§æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');

                        this.showSuccess('VIPç­‰çº§ä¿å­˜æˆåŠŸï¼?);
                    } else {
                        throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                    }
                } catch (error) {
                    console.error('â?ä¿å­˜VIPç­‰çº§å¤±è´¥:', error);
                    this.showError('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }

            showSuccess(message) {
                alert('âœ?' + message);
            }

            showError(message) {
                alert('â?' + message);
            }
        }

        // åˆå§‹åŒ–åº”ç”?
        document.addEventListener('DOMContentLoaded', () => {
            window.vipManagement = new VIPManagementFixed();
        });
    </script>
</body>
</html>
