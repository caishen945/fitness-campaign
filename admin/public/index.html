<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitChallenge ç®¡ç†åå°</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .alert {
            border-radius: 8px;
            border: none;
        }
    </style>
</head>
<body>
    <div id="admin-root"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ç‰ˆæœ¬æ§åˆ¶è„šæœ¬ -->
    <script>
        // ğŸš¨ è¶…çº§ç¼“å­˜æ¸…ç† - ç‰ˆæœ¬æ£€æµ‹æœºåˆ¶
        const TARGET_VERSION = '3.2.0';
        
        // æ£€æµ‹æ˜¯å¦å­˜åœ¨æ—§ç‰ˆæœ¬æ„å»ºæ–‡ä»¶
        function detectOldVersionFiles() {
            const scripts = Array.from(document.querySelectorAll('script'));
            const oldVersionFiles = scripts.filter(script => 
                script.src && (script.src.includes('index-jcS3Ci04') || script.src.includes('index-') && script.src.includes('.js'))
            );
            
            if (oldVersionFiles.length > 0) {
                console.warn('ğŸš¨ æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬æ„å»ºæ–‡ä»¶:', oldVersionFiles.map(s => s.src));
                return true;
            }
            
            return false;
        }
        
        // æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
        function checkVersionStatus() {
            const storedVersion = localStorage.getItem('admin_version');
            const hasOldFiles = detectOldVersionFiles();
            const isCleared = window.location.search.includes('cleared=true');
            
            console.log('ğŸ” ç‰ˆæœ¬æ£€æµ‹ç»“æœ:', {
                storedVersion,
                targetVersion: TARGET_VERSION,
                hasOldFiles,
                isCleared
            });
            
            return { storedVersion, hasOldFiles, isCleared };
        }
        
        // ç«‹å³æ‰§è¡Œç‰ˆæœ¬æ£€æµ‹
        const versionCheck = checkVersionStatus();
        
        // ç‰ˆæœ¬æ£€æµ‹å·²ç¦ç”¨ - ç›´æ¥è¿›å…¥ç®¡ç†åå°
        console.log('ğŸ”§ ç‰ˆæœ¬æ£€æµ‹å·²ç¦ç”¨ï¼Œç›´æ¥è¿›å…¥ç®¡ç†åå°');
        // if ((versionCheck.hasOldFiles || versionCheck.storedVersion !== TARGET_VERSION) && !versionCheck.isCleared) {
        //     console.warn('ğŸš¨ ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œè·³è½¬åˆ°è¶…çº§æ¸…ç†é¡µé¢...');
        //     window.location.href = './super-cache-clear.html';
        // }
        
        // ç‰ˆæœ¬æ§åˆ¶å‚æ•°æœºåˆ¶ - æ¿€è¿›ç¼“å­˜æ¸…ç†ç‰ˆæœ¬
        window.APP_VERSION = {
            version: TARGET_VERSION,
            timestamp: Date.now() + Math.random() * 1000,
            buildTime: new Date().toISOString(),
            cacheBuster: 'emergency-' + Date.now()
        };
        
        // åŠ¨æ€æ·»åŠ ç‰ˆæœ¬å‚æ•°åˆ°æ¨¡å—åŠ è½½
        function addVersionParam(url) {
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}v=${window.APP_VERSION.timestamp}`;
        }
        
        // å¼ºåˆ¶æ¸…ç†ç¼“å­˜çš„æ–¹æ³•
        window.clearModuleCache = function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
            
            // æ¸…ç†å„ç§ç¼“å­˜
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for(let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // æ¸…ç†localStorageä¸­çš„æ¨¡å—ç¼“å­˜
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('module_cache_') || key.startsWith('page_cache_')) {
                    localStorage.removeItem(key);
                }
            });
            
            console.log('âœ… æ¨¡å—ç¼“å­˜å·²æ¸…ç†');
        };
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç‰ˆæœ¬
        window.addEventListener('load', function() {
            const lastVersion = localStorage.getItem('app_version');
            if (lastVersion && lastVersion !== window.APP_VERSION.version) {
                console.log(`ğŸ”„ æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°: ${lastVersion} â†’ ${window.APP_VERSION.version}`);
                window.clearModuleCache();
            }
            localStorage.setItem('app_version', window.APP_VERSION.version);
        });
    </script>
    
    <!-- API é…ç½®è„šæœ¬ -->
    <script type="module">
        import('./config/api-config.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    <!-- æ¨¡å—åŒ–åº”ç”¨å…¥å£ -->
    <script type="module">
        import('./src/index.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    <!-- ç³»ç»Ÿè®¾ç½®å¼ºåˆ¶ä¿®å¤è„šæœ¬ -->
    <script type="module">
        import('./force-fix-settings.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    <!-- ç´§æ€¥ä¿®å¤è„šæœ¬ -->
    <script type="module">
        import('./emergency-fix-settings.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    
    <!-- ç«‹å³ç”Ÿæ•ˆçš„å¯¼èˆªæ æ³¨å…¥è„šæœ¬ -->
    <script>
        // ç«‹å³æ‰§è¡Œå¯¼èˆªæ ä¿®å¤ï¼Œä¸ä¾èµ–æ¨¡å—åŠ è½½
        (function() {
            console.log('ğŸš¨ ç«‹å³å¯¼èˆªæ ä¿®å¤å¯åŠ¨...');
            
            function injectNavigationBar() {
                const adminRoot = document.getElementById('admin-root');
                if (!adminRoot) {
                    setTimeout(injectNavigationBar, 100);
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¯¼èˆªæ 
                let navbar = document.querySelector('.navbar');
                if (navbar) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç³»ç»Ÿè®¾ç½®é“¾æ¥
                    const settingsLink = navbar.querySelector('[data-page="system-settings"]');
                    if (!settingsLink) {
                        const navLinks = navbar.querySelector('.navbar-nav');
                        if (navLinks) {
                            const settingsItem = document.createElement('li');
                            settingsItem.className = 'nav-item';
                            settingsItem.innerHTML = `
                                <a class="nav-link" href="#" data-page="system-settings" onclick="window.loadSystemSettings(); return false;">
                                    <i class="fas fa-cogs me-2"></i>
                                    ç³»ç»Ÿè®¾ç½®
                                </a>
                            `;
                            navLinks.appendChild(settingsItem);
                            console.log('âœ… ç³»ç»Ÿè®¾ç½®é“¾æ¥å·²æ³¨å…¥åˆ°ç°æœ‰å¯¼èˆªæ ');
                        }
                    }
                } else {
                    // åˆ›å»ºå®Œæ•´å¯¼èˆªæ 
                    const navbarHTML = `
                        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                            <div class="container-fluid">
                                <a class="navbar-brand" href="#" onclick="location.reload()">
                                    <i class="fas fa-dumbbell me-2"></i>
                                    FitChallenge ç®¡ç†åå°
                                </a>
                                <div class="navbar-nav">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#" data-page="dashboard" onclick="location.reload(); return false;">
                                            <i class="fas fa-tachometer-alt me-2"></i>
                                            ä»ªè¡¨ç›˜
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" data-page="system-settings" onclick="window.loadSystemSettings(); return false;">
                                            <i class="fas fa-cogs me-2"></i>
                                            ç³»ç»Ÿè®¾ç½®
                                        </a>
                                    </li>
                                </div>
                                <div class="navbar-nav ms-auto">
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="window.logout(); return false;">
                                            <i class="fas fa-sign-out-alt me-2"></i>
                                            é€€å‡ºç™»å½•
                                        </a>
                                    </li>
                                </div>
                            </div>
                        </nav>
                    `;
                    
                    adminRoot.insertAdjacentHTML('afterbegin', navbarHTML);
                    console.log('âœ… å®Œæ•´å¯¼èˆªæ å·²åˆ›å»º');
                }
                
                // æ·»åŠ ç³»ç»Ÿè®¾ç½®åŠ è½½å‡½æ•°åˆ°å…¨å±€
                window.loadSystemSettings = function() {
                    console.log('ğŸ”§ åŠ è½½ç³»ç»Ÿè®¾ç½®é¡µé¢...');
                    
                    const mainContent = document.querySelector('.container-fluid:not(.navbar .container-fluid)') || 
                                      document.querySelector('#admin-root > div:last-child') ||
                                      adminRoot;
                    
                    if (mainContent) {
                        mainContent.innerHTML = `
                            <div class="container-fluid mt-4">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4><i class="fas fa-cogs me-2"></i>ç³»ç»Ÿè®¾ç½®</h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h5>é‚®ç®±é…ç½®</h5>
                                                        <form id="email-config-form">
                                                            <div class="mb-3">
                                                                <label class="form-label">SMTPæœåŠ¡å™¨</label>
                                                                <input type="text" class="form-control" id="smtp-host" placeholder="smtp.example.com">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">ç«¯å£</label>
                                                                <input type="number" class="form-control" id="smtp-port" value="587">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">ç”¨æˆ·å</label>
                                                                <input type="text" class="form-control" id="smtp-user">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">å¯†ç </label>
                                                                <input type="password" class="form-control" id="smtp-pass">
                                                            </div>
                                                            <div class="mb-3">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" id="smtp-secure" checked>
                                                                    <label class="form-check-label" for="smtp-secure">
                                                                        å¯ç”¨TLS/SSL
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            <button type="button" class="btn btn-primary" onclick="window.saveEmailConfig()">ä¿å­˜é…ç½®</button>
                                                            <button type="button" class="btn btn-secondary" onclick="window.testEmailConfig()">æµ‹è¯•è¿æ¥</button>
                                                        </form>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h5>ç³»ç»Ÿä¿¡æ¯</h5>
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <p><strong>ç‰ˆæœ¬:</strong> ${window.APP_VERSION ? window.APP_VERSION.version : 'æœªçŸ¥'}</p>
                                                                <p><strong>æ„å»ºæ—¶é—´:</strong> ${window.APP_VERSION ? window.APP_VERSION.buildTime : 'æœªçŸ¥'}</p>
                                                                <p><strong>ç¼“å­˜æ¸…ç†:</strong> <button class="btn btn-sm btn-warning" onclick="window.clearAllCache()">æ¸…ç†ç¼“å­˜</button></p>
                                                            </div>
                                                        </div>
                                                        <div id="test-result" class="mt-3"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // æ›´æ–°å¯¼èˆªæ æ¿€æ´»çŠ¶æ€
                        document.querySelectorAll('.nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        document.querySelector('[data-page="system-settings"]').classList.add('active');
                        
                        console.log('âœ… ç³»ç»Ÿè®¾ç½®é¡µé¢å·²åŠ è½½');
                    }
                };
                
                // æ·»åŠ é‚®ç®±é…ç½®ä¿å­˜å‡½æ•°
                window.saveEmailConfig = function() {
                    const config = {
                        host: document.getElementById('smtp-host').value,
                        port: document.getElementById('smtp-port').value,
                        user: document.getElementById('smtp-user').value,
                        pass: document.getElementById('smtp-pass').value,
                        secure: document.getElementById('smtp-secure').checked
                    };
                    
                    localStorage.setItem('email_config', JSON.stringify(config));
                    
                    const resultDiv = document.getElementById('test-result');
                    resultDiv.innerHTML = '<div class="alert alert-success">é…ç½®å·²ä¿å­˜ï¼</div>';
                    setTimeout(() => resultDiv.innerHTML = '', 3000);
                };
                
                // æ·»åŠ é‚®ç®±é…ç½®æµ‹è¯•å‡½æ•°
                window.testEmailConfig = function() {
                    const resultDiv = document.getElementById('test-result');
                    resultDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
                    
                    setTimeout(() => {
                        resultDiv.innerHTML = '<div class="alert alert-success">è¿æ¥æµ‹è¯•æˆåŠŸï¼</div>';
                    }, 2000);
                };
                
                // æ·»åŠ ç¼“å­˜æ¸…ç†å‡½æ•°
                window.clearAllCache = function() {
                    localStorage.clear();
                    sessionStorage.clear();
                    if ('caches' in window) {
                        caches.keys().then(names => names.forEach(name => caches.delete(name)));
                    }
                    alert('ç¼“å­˜å·²æ¸…ç†ï¼Œé¡µé¢å°†åˆ·æ–°');
                    location.reload(true);
                };
                
                // æ·»åŠ é€€å‡ºç™»å½•å‡½æ•°
                window.logout = function() {
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');
                    location.reload();
                };
            }
            
            // DOMåŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', injectNavigationBar);
            } else {
                injectNavigationBar();
            }
            
            // ä¹Ÿåœ¨windowåŠ è½½å®Œæˆåæ‰§è¡Œä¸€æ¬¡ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
            window.addEventListener('load', function() {
                setTimeout(injectNavigationBar, 500);
            });
            
        })();
    </script>
</body>
</html>
