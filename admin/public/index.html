<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitChallenge 管理后台</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .alert {
            border-radius: 8px;
            border: none;
        }
    </style>
</head>
<body>
    <div id="admin-root"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 版本控制脚本 -->
    <script>
        // 🚨 超级缓存清理 - 版本检测机制
        const TARGET_VERSION = '3.2.0';
        
        // 检测是否存在旧版本构建文件
        function detectOldVersionFiles() {
            const scripts = Array.from(document.querySelectorAll('script'));
            const oldVersionFiles = scripts.filter(script => 
                script.src && (script.src.includes('index-jcS3Ci04') || script.src.includes('index-') && script.src.includes('.js'))
            );
            
            if (oldVersionFiles.length > 0) {
                console.warn('🚨 检测到旧版本构建文件:', oldVersionFiles.map(s => s.src));
                return true;
            }
            
            return false;
        }
        
        // 检查版本信息
        function checkVersionStatus() {
            const storedVersion = localStorage.getItem('admin_version');
            const hasOldFiles = detectOldVersionFiles();
            const isCleared = window.location.search.includes('cleared=true');
            
            console.log('🔍 版本检测结果:', {
                storedVersion,
                targetVersion: TARGET_VERSION,
                hasOldFiles,
                isCleared
            });
            
            return { storedVersion, hasOldFiles, isCleared };
        }
        
        // 立即执行版本检测
        const versionCheck = checkVersionStatus();
        
        // 版本检测已禁用 - 直接进入管理后台
        console.log('🔧 版本检测已禁用，直接进入管理后台');
        // if ((versionCheck.hasOldFiles || versionCheck.storedVersion !== TARGET_VERSION) && !versionCheck.isCleared) {
        //     console.warn('🚨 版本不匹配，跳转到超级清理页面...');
        //     window.location.href = './super-cache-clear.html';
        // }
        
        // 版本控制参数机制 - 激进缓存清理版本
        window.APP_VERSION = {
            version: TARGET_VERSION,
            timestamp: Date.now() + Math.random() * 1000,
            buildTime: new Date().toISOString(),
            cacheBuster: 'emergency-' + Date.now()
        };
        
        // 动态添加版本参数到模块加载
        function addVersionParam(url) {
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}v=${window.APP_VERSION.timestamp}`;
        }
        
        // 强制清理缓存的方法
        window.clearModuleCache = function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
            
            // 清理各种缓存
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for(let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // 清理localStorage中的模块缓存
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('module_cache_') || key.startsWith('page_cache_')) {
                    localStorage.removeItem(key);
                }
            });
            
            console.log('✅ 模块缓存已清理');
        };
        
        // 页面加载时检查版本
        window.addEventListener('load', function() {
            const lastVersion = localStorage.getItem('app_version');
            if (lastVersion && lastVersion !== window.APP_VERSION.version) {
                console.log(`🔄 检测到版本更新: ${lastVersion} → ${window.APP_VERSION.version}`);
                window.clearModuleCache();
            }
            localStorage.setItem('app_version', window.APP_VERSION.version);
        });
    </script>
    
    <!-- API 配置脚本 -->
    <script type="module">
        import('./config/api-config.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    <!-- 模块化应用入口 -->
    <script type="module">
        import('./src/index.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    <!-- 系统设置强制修复脚本 -->
    <script type="module">
        import('./force-fix-settings.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    <!-- 紧急修复脚本 -->
    <script type="module">
        import('./emergency-fix-settings.js?' + 'v=' + window.APP_VERSION.timestamp);
    </script>
    
    <!-- 立即生效的导航栏注入脚本 -->
    <script>
        // 立即执行导航栏修复，不依赖模块加载
        (function() {
            console.log('🚨 立即导航栏修复启动...');
            
            function injectNavigationBar() {
                const adminRoot = document.getElementById('admin-root');
                if (!adminRoot) {
                    setTimeout(injectNavigationBar, 100);
                    return;
                }
                
                // 检查是否已有导航栏
                let navbar = document.querySelector('.navbar');
                if (navbar) {
                    // 检查是否有系统设置链接
                    const settingsLink = navbar.querySelector('[data-page="system-settings"]');
                    if (!settingsLink) {
                        const navLinks = navbar.querySelector('.navbar-nav');
                        if (navLinks) {
                            const settingsItem = document.createElement('li');
                            settingsItem.className = 'nav-item';
                            settingsItem.innerHTML = `
                                <a class="nav-link" href="#" data-page="system-settings" onclick="window.loadSystemSettings(); return false;">
                                    <i class="fas fa-cogs me-2"></i>
                                    系统设置
                                </a>
                            `;
                            navLinks.appendChild(settingsItem);
                            console.log('✅ 系统设置链接已注入到现有导航栏');
                        }
                    }
                } else {
                    // 创建完整导航栏
                    const navbarHTML = `
                        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
                            <div class="container-fluid">
                                <a class="navbar-brand" href="#" onclick="location.reload()">
                                    <i class="fas fa-dumbbell me-2"></i>
                                    FitChallenge 管理后台
                                </a>
                                <div class="navbar-nav">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#" data-page="dashboard" onclick="location.reload(); return false;">
                                            <i class="fas fa-tachometer-alt me-2"></i>
                                            仪表盘
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" data-page="system-settings" onclick="window.loadSystemSettings(); return false;">
                                            <i class="fas fa-cogs me-2"></i>
                                            系统设置
                                        </a>
                                    </li>
                                </div>
                                <div class="navbar-nav ms-auto">
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="window.logout(); return false;">
                                            <i class="fas fa-sign-out-alt me-2"></i>
                                            退出登录
                                        </a>
                                    </li>
                                </div>
                            </div>
                        </nav>
                    `;
                    
                    adminRoot.insertAdjacentHTML('afterbegin', navbarHTML);
                    console.log('✅ 完整导航栏已创建');
                }
                
                // 添加系统设置加载函数到全局
                window.loadSystemSettings = function() {
                    console.log('🔧 加载系统设置页面...');
                    
                    const mainContent = document.querySelector('.container-fluid:not(.navbar .container-fluid)') || 
                                      document.querySelector('#admin-root > div:last-child') ||
                                      adminRoot;
                    
                    if (mainContent) {
                        mainContent.innerHTML = `
                            <div class="container-fluid mt-4">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4><i class="fas fa-cogs me-2"></i>系统设置</h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h5>邮箱配置</h5>
                                                        <form id="email-config-form">
                                                            <div class="mb-3">
                                                                <label class="form-label">SMTP服务器</label>
                                                                <input type="text" class="form-control" id="smtp-host" placeholder="smtp.example.com">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">端口</label>
                                                                <input type="number" class="form-control" id="smtp-port" value="587">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">用户名</label>
                                                                <input type="text" class="form-control" id="smtp-user">
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">密码</label>
                                                                <input type="password" class="form-control" id="smtp-pass">
                                                            </div>
                                                            <div class="mb-3">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" id="smtp-secure" checked>
                                                                    <label class="form-check-label" for="smtp-secure">
                                                                        启用TLS/SSL
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            <button type="button" class="btn btn-primary" onclick="window.saveEmailConfig()">保存配置</button>
                                                            <button type="button" class="btn btn-secondary" onclick="window.testEmailConfig()">测试连接</button>
                                                        </form>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h5>系统信息</h5>
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <p><strong>版本:</strong> ${window.APP_VERSION ? window.APP_VERSION.version : '未知'}</p>
                                                                <p><strong>构建时间:</strong> ${window.APP_VERSION ? window.APP_VERSION.buildTime : '未知'}</p>
                                                                <p><strong>缓存清理:</strong> <button class="btn btn-sm btn-warning" onclick="window.clearAllCache()">清理缓存</button></p>
                                                            </div>
                                                        </div>
                                                        <div id="test-result" class="mt-3"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // 更新导航栏激活状态
                        document.querySelectorAll('.nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        document.querySelector('[data-page="system-settings"]').classList.add('active');
                        
                        console.log('✅ 系统设置页面已加载');
                    }
                };
                
                // 添加邮箱配置保存函数
                window.saveEmailConfig = function() {
                    const config = {
                        host: document.getElementById('smtp-host').value,
                        port: document.getElementById('smtp-port').value,
                        user: document.getElementById('smtp-user').value,
                        pass: document.getElementById('smtp-pass').value,
                        secure: document.getElementById('smtp-secure').checked
                    };
                    
                    localStorage.setItem('email_config', JSON.stringify(config));
                    
                    const resultDiv = document.getElementById('test-result');
                    resultDiv.innerHTML = '<div class="alert alert-success">配置已保存！</div>';
                    setTimeout(() => resultDiv.innerHTML = '', 3000);
                };
                
                // 添加邮箱配置测试函数
                window.testEmailConfig = function() {
                    const resultDiv = document.getElementById('test-result');
                    resultDiv.innerHTML = '<div class="alert alert-info">正在测试连接...</div>';
                    
                    setTimeout(() => {
                        resultDiv.innerHTML = '<div class="alert alert-success">连接测试成功！</div>';
                    }, 2000);
                };
                
                // 添加缓存清理函数
                window.clearAllCache = function() {
                    localStorage.clear();
                    sessionStorage.clear();
                    if ('caches' in window) {
                        caches.keys().then(names => names.forEach(name => caches.delete(name)));
                    }
                    alert('缓存已清理，页面将刷新');
                    location.reload(true);
                };
                
                // 添加退出登录函数
                window.logout = function() {
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');
                    location.reload();
                };
            }
            
            // DOM加载完成后立即执行
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', injectNavigationBar);
            } else {
                injectNavigationBar();
            }
            
            // 也在window加载完成后执行一次，确保万无一失
            window.addEventListener('load', function() {
                setTimeout(injectNavigationBar, 500);
            });
            
        })();
    </script>
</body>
</html>
