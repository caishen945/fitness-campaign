<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPä¿å­˜é—®é¢˜è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; }
        .success { background: #e8f5e9; }
        .warning { background: #fff3e0; }
        button { padding: 10px 20px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>ğŸ” VIPç­‰çº§ä¿å­˜é—®é¢˜è°ƒè¯•</h1>
    
    <div>
        <h3>æ­¥éª¤1ï¼šç®¡ç†å‘˜ç™»å½•</h3>
        <input type="text" id="username" placeholder="ç”¨æˆ·å? value="superadmin">
        <input type="password" id="password" placeholder="å¯†ç " value="Admin123!@#">
        <button onclick="adminLogin()">ç™»å½•</button>
    </div>

    <div>
        <h3>æ­¥éª¤2ï¼šæµ‹è¯•VIPæ›´æ–°</h3>
        <input type="text" id="levelName" placeholder="ç­‰çº§åç§°" value="æµ‹è¯•ç­‰çº§">
        <input type="number" id="stepGoal" placeholder="æ­¥æ•°ç›®æ ‡" value="1000">
        <button onclick="testVipUpdate()" disabled id="updateBtn">æ›´æ–°VIPç­‰çº§1</button>
    </div>

    <div id="logs"></div>

    <script>
        let adminToken = null;

        function log(message, type = 'log') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logs.appendChild(logDiv);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        async function adminLogin() {
            try {
                log('ğŸ”„ å¼€å§‹ç®¡ç†å‘˜ç™»å½•...');
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                const loginData = {
                    username: username,
                    password: password
                };

                log(`ğŸ“¡ å‘é€ç™»å½•è¯·æ±? ${JSON.stringify(loginData)}`);

                const response = await fetch('http://localhost:3000/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });

                log(`ğŸ“¥ ç™»å½•å“åº”çŠ¶æ€? ${response.status} ${response.statusText}`);

                const result = await response.json();
                log(`ğŸ“¥ ç™»å½•å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`);

                if (result.success) {
                    adminToken = result.data.token;
                    log(`âœ?ç™»å½•æˆåŠŸï¼Token: ${adminToken.substring(0, 30)}...`, 'success');
                    document.getElementById('updateBtn').disabled = false;
                } else {
                    log(`â?ç™»å½•å¤±è´¥: ${result.message}`, 'error');
                }

            } catch (error) {
                log(`â?ç™»å½•å¼‚å¸¸: ${error.message}`, 'error');
                console.error('ç™»å½•é”™è¯¯:', error);
            }
        }

        async function testVipUpdate() {
            if (!adminToken) {
                log('â?è¯·å…ˆç™»å½•ï¼?, 'error');
                return;
            }

            try {
                log('ğŸ”„ å¼€å§‹VIPç­‰çº§æ›´æ–°æµ‹è¯•...');

                const updateData = {
                    name: document.getElementById('levelName').value,
                    step_goal: parseInt(document.getElementById('stepGoal').value),
                    deposit: 100,
                    reward: 120,
                    challenge_times: 3,
                    color: '#FFD700',
                    is_active: true
                };

                log(`ğŸ“¡ å‘é€æ›´æ–°è¯·æ±‚æ•°æ? ${JSON.stringify(updateData, null, 2)}`);
                log(`ğŸ”‘ ä½¿ç”¨Token: Bearer ${adminToken.substring(0, 30)}...`);

                const response = await fetch('http://localhost:3000/api/admin/vip-levels/1', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(updateData)
                });

                log(`ğŸ“¥ æ›´æ–°å“åº”çŠ¶æ€? ${response.status} ${response.statusText}`);
                log(`ğŸ“¥ å“åº”å¤´ä¿¡æ? ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);

                let result;
                try {
                    result = await response.json();
                    log(`ğŸ“¥ æ›´æ–°å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`);
                } catch (e) {
                    const text = await response.text();
                    log(`ğŸ“¥ æ›´æ–°å“åº”æ–‡æœ¬: ${text}`);
                    result = { error: 'å“åº”ä¸æ˜¯JSONæ ¼å¼', text: text };
                }

                if (response.ok && result.success) {
                    log(`âœ?VIPç­‰çº§æ›´æ–°æˆåŠŸï¼`, 'success');
                } else {
                    log(`â?VIPç­‰çº§æ›´æ–°å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    
                    if (response.status === 401) {
                        log(`ğŸš¨ è®¤è¯å¤±è´¥ - è¿™å¯èƒ½æ˜¯å¯¼è‡´è‡ªåŠ¨ç™»å‡ºçš„åŸå› ï¼`, 'error');
                        log(`ğŸ” æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ...`, 'warning');
                        
                        // å°è¯•éªŒè¯Token
                        try {
                            const tokenParts = adminToken.split('.');
                            if (tokenParts.length === 3) {
                                const payload = JSON.parse(atob(tokenParts[1]));
                                log(`ğŸ” Tokenè§£æ: ${JSON.stringify(payload, null, 2)}`, 'warning');
                                
                                const now = Date.now() / 1000;
                                if (payload.exp && payload.exp < now) {
                                    log(`â?Tokenå·²è¿‡æœ? è¿‡æœŸæ—¶é—´: ${new Date(payload.exp * 1000).toLocaleString()}`, 'error');
                                } else {
                                    log(`â?Tokenæœªè¿‡æœ? è¿‡æœŸæ—¶é—´: ${new Date(payload.exp * 1000).toLocaleString()}`, 'success');
                                }
                            }
                        } catch (e) {
                            log(`â?Tokenè§£æå¤±è´¥: ${e.message}`, 'error');
                        }
                    }
                }

            } catch (error) {
                log(`â?æ›´æ–°å¼‚å¸¸: ${error.message}`, 'error');
                console.error('æ›´æ–°é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        log('ğŸ¯ VIPç­‰çº§ä¿å­˜é—®é¢˜è°ƒè¯•å·¥å…·å·²å°±ç»?);
        log('ğŸ“‹ æ­¥éª¤ï¼?) å…ˆç‚¹å‡»ç™»å½•æŒ‰é’?2) ç„¶åç‚¹å‡»æ›´æ–°VIPç­‰çº§æŒ‰é’®');
        log('ğŸ” è¿™ä¸ªå·¥å…·ä¼šè¯¦ç»†è®°å½•æ‰€æœ‰ç½‘ç»œè¯·æ±‚å’Œå“åº”ï¼Œå¸®åŠ©è¯Šæ–­è‡ªåŠ¨ç™»å‡ºé—®é¢?);
    </script>
</body>
</html>
