<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” FitChallenge ç³»ç»Ÿæ—¥å¿—æŸ¥çœ‹å™?/title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            color: white;
            margin-bottom: 10px;
        }

        .controls {
            background: #2a2a2a;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid #444;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 500;
            min-width: 60px;
        }

        select, input, button {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: #e0e0e0;
            font-size: 14px;
        }

        button {
            background: #667eea;
            color: white;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .stats {
            background: #2a2a2a;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            border-bottom: 1px solid #444;
        }

        .stat-card {
            background: #333;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
        }

        .logs-container {
            height: calc(100vh - 220px);
            overflow-y: auto;
            background: #1a1a1a;
        }

        .log-entry {
            padding: 12px;
            border-bottom: 1px solid #333;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            transition: background 0.2s ease;
        }

        .log-entry:hover {
            background: #252525;
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .log-timestamp {
            color: #888;
            font-weight: bold;
        }

        .log-level {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .log-level.INFO {
            background: #2196F3;
            color: white;
        }

        .log-level.WARN {
            background: #FF9800;
            color: white;
        }

        .log-level.ERROR {
            background: #F44336;
            color: white;
        }

        .log-level.SUCCESS {
            background: #4CAF50;
            color: white;
        }

        .log-level.DEBUG {
            background: #9C27B0;
            color: white;
        }

        .log-category {
            background: #555;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .log-message {
            margin: 5px 0;
            color: #e0e0e0;
        }

        .log-data {
            background: #2a2a2a;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
            border-left: 3px solid #667eea;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-data pre {
            color: #a5d6ff;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error-stack {
            background: #2d1b1b;
            border-left: 3px solid #f44336;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
        }

        .error-stack pre {
            color: #ffcdd2;
            font-size: 11px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .no-logs {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-connected {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: #F44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .auto-scroll {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .filter-active {
            background: #4CAF50 !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” FitChallenge ç³»ç»Ÿæ—¥å¿—æŸ¥çœ‹å™?/h1>
        <p>å®æ—¶ç›‘æ§å‰ç«¯ã€åç«¯ã€ç®¡ç†å‘˜æ“ä½œæ—¥å¿—</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <span class="status-indicator" id="connectionStatus"></span>
            <span id="connectionText">è¿æ¥ä¸?..</span>
        </div>

        <div class="control-group">
            <label>æ—¥å¿—æº?</label>
            <select id="sourceFilter">
                <option value="all">å…¨éƒ¨</option>
                <option value="backend">åç«¯</option>
                <option value="frontend">å‰ç«¯</option>
                <option value="admin">ç®¡ç†å‘?/option>
            </select>
        </div>

        <div class="control-group">
            <label>çº§åˆ«:</label>
            <select id="levelFilter">
                <option value="all">å…¨éƒ¨</option>
                <option value="ERROR">é”™è¯¯</option>
                <option value="WARN">è­¦å‘Š</option>
                <option value="INFO">ä¿¡æ¯</option>
                <option value="SUCCESS">æˆåŠŸ</option>
                <option value="DEBUG">è°ƒè¯•</option>
            </select>
        </div>

        <div class="control-group">
            <label>åˆ†ç±»:</label>
            <select id="categoryFilter">
                <option value="all">å…¨éƒ¨</option>
                <option value="VIP-MANAGEMENT">VIPç®¡ç†</option>
                <option value="AUTH">è®¤è¯</option>
                <option value="API">API</option>
                <option value="DATABASE">æ•°æ®åº?/option>
                <option value="SYSTEM">ç³»ç»Ÿ</option>
            </select>
        </div>

        <div class="control-group">
            <input type="text" id="searchInput" placeholder="æœç´¢æ—¥å¿—..." />
        </div>

                 <div class="control-group">
             <button onclick="clearLogs()">æ¸…é™¤æ˜¾ç¤º</button>
             <button onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
             <button onclick="refreshLogs()">åˆ·æ–°</button>
             <button onclick="initializeLogs()">åˆå§‹åŒ–æ—¥å¿?/button>
         </div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="totalLogs">0</div>
            <div class="stat-label">æ€»æ—¥å¿—æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="errorCount">0</div>
            <div class="stat-label">é”™è¯¯æ•?/div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="warningCount">0</div>
            <div class="stat-label">è­¦å‘Šæ•?/div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="vipOperations">0</div>
            <div class="stat-label">VIPæ“ä½œ</div>
        </div>
    </div>

    <div class="logs-container" id="logsContainer">
        <div class="loading">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
    </div>

    <div class="auto-scroll">
        <button id="autoScrollBtn" onclick="toggleAutoScroll()">è‡ªåŠ¨æ»šåŠ¨: å¼€</button>
    </div>

    <script>
        class LogViewer {
            constructor() {
                this.logs = [];
                this.filteredLogs = [];
                this.autoScroll = true;
                this.filters = {
                    source: 'all',
                    level: 'all', 
                    category: 'all',
                    search: ''
                };

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadLogs();
                this.startPolling();
                this.updateConnectionStatus(true);
            }

            setupEventListeners() {
                document.getElementById('sourceFilter').addEventListener('change', (e) => {
                    this.filters.source = e.target.value;
                    this.applyFilters();
                });

                document.getElementById('levelFilter').addEventListener('change', (e) => {
                    this.filters.level = e.target.value;
                    this.applyFilters();
                });

                document.getElementById('categoryFilter').addEventListener('change', (e) => {
                    this.filters.category = e.target.value;
                    this.applyFilters();
                });

                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filters.search = e.target.value;
                    this.applyFilters();
                });
            }

                         async loadLogs() {
                 try {
                     // ä»localStorageåŠ è½½å‰ç«¯å’Œç®¡ç†å‘˜æ—¥å¿—
                     const frontendLogs = JSON.parse(localStorage.getItem('frontendLogs') || '[]');
                     const adminLogs = JSON.parse(localStorage.getItem('adminLogs') || '[]');
                     
                     // åˆå¹¶å¹¶æ’åºæ—¥å¿?
                     this.logs = [
                         ...frontendLogs.map(log => ({ ...log, source: 'frontend' })),
                         ...adminLogs.map(log => ({ ...log, source: 'admin' }))
                     ].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                     // å¦‚æœæ²¡æœ‰æ—¥å¿—ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ?
                     if (this.logs.length === 0) {
                         console.log('æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—æ•°æ®ï¼Œå¯èƒ½éœ€è¦å…ˆè®¿é—®ç®¡ç†å‘˜é¡µé¢æˆ–å‰ç«¯é¡µé¢æ¥åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ');
                     }

                     this.applyFilters();
                     this.updateStats();
                 } catch (error) {
                     console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                     // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                     const container = document.getElementById('logsContainer');
                     container.innerHTML = `<div class="no-logs">åŠ è½½æ—¥å¿—å¤±è´¥: ${error.message}</div>`;
                 }
             }

            startPolling() {
                // æ¯?ç§’åˆ·æ–°ä¸€æ¬¡æ—¥å¿?
                setInterval(() => {
                    this.loadLogs();
                }, 5000);
            }

            applyFilters() {
                this.filteredLogs = this.logs.filter(log => {
                    if (this.filters.source !== 'all' && log.source !== this.filters.source) {
                        return false;
                    }
                    if (this.filters.level !== 'all' && log.level !== this.filters.level) {
                        return false;
                    }
                    if (this.filters.category !== 'all' && log.category !== this.filters.category) {
                        return false;
                    }
                    if (this.filters.search && !this.matchesSearch(log, this.filters.search)) {
                        return false;
                    }
                    return true;
                });

                this.renderLogs();
                this.updateStats();
            }

            matchesSearch(log, search) {
                const searchLower = search.toLowerCase();
                return (
                    log.message.toLowerCase().includes(searchLower) ||
                    log.category.toLowerCase().includes(searchLower) ||
                    (log.data && JSON.stringify(log.data).toLowerCase().includes(searchLower))
                );
            }

            renderLogs() {
                const container = document.getElementById('logsContainer');
                
                if (this.filteredLogs.length === 0) {
                    container.innerHTML = '<div class="no-logs">æ²¡æœ‰åŒ¹é…çš„æ—¥å¿—è®°å½?/div>';
                    return;
                }

                const logsHtml = this.filteredLogs.slice(-500).map(log => this.renderLogEntry(log)).join('');
                container.innerHTML = logsHtml;

                if (this.autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            renderLogEntry(log) {
                return `
                    <div class="log-entry">
                        <div class="log-header">
                            <span class="log-timestamp">${log.timestamp}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-category">${log.category}</span>
                            <span style="color: #888; font-size: 11px;">[${log.source}]</span>
                        </div>
                        <div class="log-message">${this.escapeHtml(log.message)}</div>
                        ${log.data ? `<div class="log-data"><pre>${this.escapeHtml(JSON.stringify(log.data, null, 2))}</pre></div>` : ''}
                        ${log.error ? `<div class="error-stack"><pre>${this.escapeHtml(log.error.stack || log.error.message)}</pre></div>` : ''}
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateStats() {
                document.getElementById('totalLogs').textContent = this.filteredLogs.length;
                document.getElementById('errorCount').textContent = this.filteredLogs.filter(log => log.level === 'ERROR').length;
                document.getElementById('warningCount').textContent = this.filteredLogs.filter(log => log.level === 'WARN').length;
                document.getElementById('vipOperations').textContent = this.filteredLogs.filter(log => log.category === 'VIP-MANAGEMENT').length;
            }

            updateConnectionStatus(connected) {
                const indicator = document.getElementById('connectionStatus');
                const text = document.getElementById('connectionText');
                
                if (connected) {
                    indicator.className = 'status-indicator status-connected';
                    text.textContent = 'å·²è¿æ?;
                } else {
                    indicator.className = 'status-indicator status-disconnected'; 
                    text.textContent = 'è¿æ¥æ–­å¼€';
                }
            }
        }

        // å…¨å±€å‡½æ•°
        function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ˜¾ç¤ºçš„æ—¥å¿—å—ï¼Ÿ')) {
                document.getElementById('logsContainer').innerHTML = '<div class="no-logs">æ—¥å¿—å·²æ¸…é™?/div>';
            }
        }

        function exportLogs() {
            const logs = logViewer.filteredLogs;
            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fitchallenge-logs-${new Date().toISOString().substring(0, 19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function refreshLogs() {
            logViewer.loadLogs();
        }

                 function toggleAutoScroll() {
             logViewer.autoScroll = !logViewer.autoScroll;
             const btn = document.getElementById('autoScrollBtn');
             btn.textContent = `è‡ªåŠ¨æ»šåŠ¨: ${logViewer.autoScroll ? 'å¼€' : 'å…?}`;
             
             if (logViewer.autoScroll) {
                 const container = document.getElementById('logsContainer');
                 container.scrollTop = container.scrollHeight;
             }
         }

         function initializeLogs() {
             try {
                 // åˆ›å»ºä¸€äº›åˆå§‹æµ‹è¯•æ—¥å¿?
                 const testLogs = [
                     {
                         timestamp: new Date().toISOString().replace('T', ' ').substring(0, 23),
                         level: 'INFO',
                         category: 'SYSTEM',
                         message: 'æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ?,
                         data: { action: 'manual_init', timestamp: Date.now() }
                     },
                     {
                         timestamp: new Date().toISOString().replace('T', ' ').substring(0, 23),
                         level: 'SUCCESS',
                         category: 'SYSTEM',
                         message: 'æ—¥å¿—æŸ¥çœ‹å™¨å¯åŠ¨æˆåŠ?,
                         data: { url: window.location.href }
                     }
                 ];

                 // ä¿å­˜åˆ°localStorage
                 const existingLogs = JSON.parse(localStorage.getItem('adminLogs') || '[]');
                 existingLogs.push(...testLogs);
                 localStorage.setItem('adminLogs', JSON.stringify(existingLogs));

                 // åˆ·æ–°æ—¥å¿—æ˜¾ç¤º
                 logViewer.loadLogs();
                 alert('âœ?æ—¥å¿—ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼?);
             } catch (error) {
                 alert('â?åˆå§‹åŒ–æ—¥å¿—å¤±è´? ' + error.message);
             }
         }

        // åˆå§‹åŒ–æ—¥å¿—æŸ¥çœ‹å™¨
        const logViewer = new LogViewer();
    </script>
</body>
</html>
