<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket实时通信测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .test-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #4ECDC4;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4ECDC4;
        }
        
        .btn {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background: #51cf66;
            box-shadow: 0 0 10px rgba(81, 207, 102, 0.5);
        }
        
        .status-disconnected {
            background: #ff6b6b;
        }
        
        .status-connecting {
            background: #ffd43b;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .log-container {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-timestamp {
            color: #888;
            font-size: 11px;
        }
        
        .log-message {
            color: #f8f8f2;
        }
        
        .log-error {
            color: #ff6b6b;
        }
        
        .log-success {
            color: #51cf66;
        }
        
        .log-info {
            color: #74c0fc;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #f0f0f0;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .challenge-updates {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .challenge-update {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #4ECDC4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .challenge-update h4 {
            color: #333;
            margin-bottom: 8px;
        }
        
        .challenge-update p {
            color: #666;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ECDC4 0%, #44A08D 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔌 WebSocket实时通信测试</h1>
            <p>测试VIP挑战系统的实时进度更新和推送通知功能</p>
        </div>
        
        <div class="content">
            <!-- 连接状态和配置 -->
            <div class="test-section">
                <h3>🔗 连接配置</h3>
                <div class="form-group">
                    <label>WebSocket服务器地址:</label>
                    <input type="text" id="wsUrl" value="ws://localhost:3000/ws" placeholder="WebSocket服务器地址">
                </div>
                <div class="form-group">
                    <label>JWT Token:</label>
                    <input type="text" id="jwtToken" placeholder="输入JWT认证令牌" style="font-family: monospace;">
                </div>
                <div class="form-group">
                    <button class="btn" id="connectBtn" onclick="connectWebSocket()">连接</button>
                    <button class="btn btn-danger" id="disconnectBtn" onclick="disconnectWebSocket()" disabled>断开</button>
                    <span id="connectionStatus">
                        <span class="status-indicator status-disconnected"></span>
                        <span id="statusText">未连接</span>
                    </span>
                </div>
            </div>
            
            <!-- 认证和订阅 -->
            <div class="test-section">
                <h3>🔐 用户认证和挑战订阅</h3>
                <div class="form-group">
                    <label>用户ID:</label>
                    <input type="number" id="userId" value="1" placeholder="用户ID">
                </div>
                <div class="form-group">
                    <label>挑战ID:</label>
                    <input type="number" id="challengeId" value="1" placeholder="挑战ID">
                </div>
                <div class="form-group">
                    <button class="btn btn-success" id="authBtn" onclick="authenticateUser()" disabled>认证用户</button>
                    <button class="btn" id="subscribeBtn" onclick="subscribeToChallenge()" disabled>订阅挑战</button>
                    <button class="btn" id="unsubscribeBtn" onclick="unsubscribeFromChallenge()" disabled>取消订阅</button>
                </div>
            </div>
            
            <!-- 模拟挑战更新 -->
            <div class="test-section">
                <h3>🔄 模拟挑战进度更新</h3>
                <div class="form-group">
                    <label>当前步数:</label>
                    <input type="number" id="currentSteps" value="5000" placeholder="当前步数">
                </div>
                <div class="form-group">
                    <label>目标步数:</label>
                    <input type="number" id="targetSteps" value="8000" placeholder="目标步数">
                </div>
                <div class="form-group">
                    <button class="btn" id="updateProgressBtn" onclick="updateChallengeProgress()" disabled>更新进度</button>
                    <button class="btn" id="completeChallengeBtn" onclick="completeChallenge()" disabled>完成挑战</button>
                </div>
            </div>
            
            <!-- 统计信息 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalMessages">0</div>
                    <div class="stat-label">总消息数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successfulMessages">0</div>
                    <div class="stat-label">成功消息</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="errorMessages">0</div>
                    <div class="stat-label">错误消息</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="connectionTime">0s</div>
                    <div class="stat-label">连接时间</div>
                </div>
            </div>
            
            <!-- 挑战更新显示 -->
            <div class="challenge-updates">
                <h3>📊 实时挑战更新</h3>
                <div id="challengeUpdatesList">
                    <p style="text-align: center; color: #999; padding: 20px;">暂无挑战更新</p>
                </div>
            </div>
            
            <!-- 日志显示 -->
            <div class="test-section">
                <h3>📝 通信日志</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[系统]</span>
                        <span class="log-message">WebSocket测试页面已加载，等待连接...</span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="clearLog()">清空日志</button>
                    <button class="btn" onclick="exportLog()">导出日志</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class WebSocketTestClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.isAuthenticated = false;
                this.subscribedChallenges = new Set();
                this.messageCount = 0;
                this.successCount = 0;
                this.errorCount = 0;
                this.connectionStartTime = null;
                this.connectionTimer = null;
                
                this.initializeEventListeners();
            }
            
            initializeEventListeners() {
                // 监听输入框变化
                document.getElementById('wsUrl').addEventListener('input', this.updateConnectionStatus.bind(this));
                document.getElementById('jwtToken').addEventListener('input', this.updateConnectionStatus.bind(this));
            }
            
            updateConnectionStatus() {
                const url = document.getElementById('wsUrl').value;
                const token = document.getElementById('jwtToken').value;
                
                document.getElementById('connectBtn').disabled = !url || !token;
            }
            
            connect(url) {
                return new Promise((resolve, reject) => {
                    try {
                        this.log('正在连接到WebSocket服务器...', 'info');
                        this.updateStatus('connecting', '连接中...');
                        
                        this.ws = new WebSocket(url);
                        
                        this.ws.onopen = () => {
                            this.isConnected = true;
                            this.connectionStartTime = Date.now();
                            this.startConnectionTimer();
                            this.updateStatus('connected', '已连接');
                            this.log('WebSocket连接已建立', 'success');
                            this.updateButtons();
                            resolve();
                        };
                        
                        this.ws.onmessage = (event) => {
                            this.handleMessage(event.data);
                        };
                        
                        this.ws.onerror = (error) => {
                            this.log(`WebSocket错误: ${error.message || '未知错误'}`, 'error');
                            this.errorCount++;
                            this.updateStats();
                        };
                        
                        this.ws.onclose = () => {
                            this.handleDisconnection();
                        };
                        
                    } catch (error) {
                        this.log(`连接失败: ${error.message}`, 'error');
                        this.updateStatus('disconnected', '连接失败');
                        reject(error);
                    }
                });
            }
            
            disconnect() {
                if (this.ws) {
                    this.ws.close();
                }
            }
            
            handleDisconnection() {
                this.isConnected = false;
                this.isAuthenticated = false;
                this.subscribedChallenges.clear();
                this.stopConnectionTimer();
                this.updateStatus('disconnected', '已断开');
                this.log('WebSocket连接已断开', 'info');
                this.updateButtons();
            }
            
            startConnectionTimer() {
                this.connectionTimer = setInterval(() => {
                    if (this.connectionStartTime) {
                        const elapsed = Math.floor((Date.now() - this.connectionStartTime) / 1000);
                        document.getElementById('connectionTime').textContent = `${elapsed}s`;
                    }
                }, 1000);
            }
            
            stopConnectionTimer() {
                if (this.connectionTimer) {
                    clearInterval(this.connectionTimer);
                    this.connectionTimer = null;
                }
            }
            
            updateStatus(status, text) {
                const statusIndicator = document.querySelector('.status-indicator');
                const statusText = document.getElementById('statusText');
                
                statusIndicator.className = `status-indicator status-${status}`;
                statusText.textContent = text;
            }
            
            updateButtons() {
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                const authBtn = document.getElementById('authBtn');
                const subscribeBtn = document.getElementById('subscribeBtn');
                const unsubscribeBtn = document.getElementById('unsubscribeBtn');
                const updateProgressBtn = document.getElementById('updateProgressBtn');
                const completeChallengeBtn = document.getElementById('completeChallengeBtn');
                
                connectBtn.disabled = this.isConnected;
                disconnectBtn.disabled = !this.isConnected;
                authBtn.disabled = !this.isConnected;
                subscribeBtn.disabled = !this.isAuthenticated;
                unsubscribeBtn.disabled = !this.isAuthenticated || this.subscribedChallenges.size === 0;
                updateProgressBtn.disabled = !this.isAuthenticated;
                completeChallengeBtn.disabled = !this.isAuthenticated;
            }
            
            sendMessage(message) {
                if (!this.isConnected) {
                    this.log('WebSocket未连接，无法发送消息', 'error');
                    return false;
                }
                
                try {
                    this.ws.send(JSON.stringify(message));
                    this.messageCount++;
                    this.updateStats();
                    this.log(`发送消息: ${JSON.stringify(message)}`, 'info');
                    return true;
                } catch (error) {
                    this.log(`发送消息失败: ${error.message}`, 'error');
                    this.errorCount++;
                    this.updateStats();
                    return false;
                }
            }
            
            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    this.log(`收到消息: ${JSON.stringify(message)}`, 'info');
                    
                    // 处理不同类型的消息
                    switch (message.type) {
                        case 'auth_response':
                            this.handleAuthResponse(message);
                            break;
                        case 'challenge_update':
                            this.handleChallengeUpdate(message);
                            break;
                        case 'notification':
                            this.handleNotification(message);
                            break;
                        case 'error':
                            this.handleError(message);
                            break;
                        default:
                            this.log(`未知消息类型: ${message.type}`, 'info');
                    }
                    
                    this.successCount++;
                    this.updateStats();
                    
                } catch (error) {
                    this.log(`解析消息失败: ${error.message}`, 'error');
                    this.errorCount++;
                    this.updateStats();
                }
            }
            
            handleAuthResponse(message) {
                if (message.success) {
                    this.isAuthenticated = true;
                    this.log('用户认证成功', 'success');
                    this.updateButtons();
                } else {
                    this.log(`认证失败: ${message.error || '未知错误'}`, 'error');
                }
            }
            
            handleChallengeUpdate(message) {
                this.displayChallengeUpdate(message.data);
                this.log(`挑战更新: ${message.data.challengeId}`, 'success');
            }
            
            handleNotification(message) {
                this.log(`通知: ${message.message}`, 'info');
                // 可以在这里添加通知显示逻辑
            }
            
            handleError(message) {
                this.log(`错误: ${message.error}`, 'error');
                this.errorCount++;
                this.updateStats();
            }
            
            displayChallengeUpdate(data) {
                const updatesList = document.getElementById('challengeUpdatesList');
                
                if (updatesList.querySelector('p')) {
                    updatesList.innerHTML = '';
                }
                
                const updateElement = document.createElement('div');
                updateElement.className = 'challenge-update';
                
                const progress = Math.min(100, (data.currentSteps / data.targetSteps) * 100);
                
                updateElement.innerHTML = `
                    <h4>挑战 #${data.challengeId}</h4>
                    <p><strong>状态:</strong> ${data.status}</p>
                    <p><strong>当前步数:</strong> ${data.currentSteps.toLocaleString()} / ${data.targetSteps.toLocaleString()}</p>
                    <p><strong>进度:</strong> ${progress.toFixed(1)}%</p>
                    <p><strong>更新时间:</strong> ${new Date().toLocaleTimeString()}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                `;
                
                updatesList.insertBefore(updateElement, updatesList.firstChild);
                
                // 限制显示的更新数量
                const updates = updatesList.querySelectorAll('.challenge-update');
                if (updates.length > 10) {
                    updates[updates.length - 1].remove();
                }
            }
            
            updateStats() {
                document.getElementById('totalMessages').textContent = this.messageCount;
                document.getElementById('successfulMessages').textContent = this.successCount;
                document.getElementById('errorMessages').textContent = this.errorCount;
            }
            
            log(message, type = 'message') {
                const logContainer = document.getElementById('logContainer');
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = new Date().toLocaleTimeString();
                const typeClass = type === 'error' ? 'log-error' : 
                                type === 'success' ? 'log-success' : 
                                type === 'info' ? 'log-info' : 'log-message';
                
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="${typeClass}">${message}</span>
                `;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }
        
        // 全局变量
        let wsClient = new WebSocketTestClient();
        
        // 连接WebSocket
        async function connectWebSocket() {
            const url = document.getElementById('wsUrl').value;
            const token = document.getElementById('jwtToken').value;
            
            if (!url || !token) {
                wsClient.log('请输入WebSocket地址和JWT令牌', 'error');
                return;
            }
            
            try {
                await wsClient.connect(url);
            } catch (error) {
                wsClient.log(`连接失败: ${error.message}`, 'error');
            }
        }
        
        // 断开WebSocket
        function disconnectWebSocket() {
            wsClient.disconnect();
        }
        
        // 认证用户
        function authenticateUser() {
            const userId = document.getElementById('userId').value;
            const token = document.getElementById('jwtToken').value;
            
            if (!userId || !token) {
                wsClient.log('请输入用户ID和JWT令牌', 'error');
                return;
            }
            
            const authMessage = {
                type: 'authenticate',
                userId: parseInt(userId),
                token: token
            };
            
            wsClient.sendMessage(authMessage);
        }
        
        // 订阅挑战
        function subscribeToChallenge() {
            const challengeId = document.getElementById('challengeId').value;
            
            if (!challengeId) {
                wsClient.log('请输入挑战ID', 'error');
                return;
            }
            
            const subscribeMessage = {
                type: 'subscribe',
                challengeId: parseInt(challengeId)
            };
            
            wsClient.sendMessage(subscribeMessage);
            wsClient.subscribedChallenges.add(parseInt(challengeId));
            wsClient.updateButtons();
            wsClient.log(`已订阅挑战 #${challengeId}`, 'success');
        }
        
        // 取消订阅挑战
        function unsubscribeFromChallenge() {
            const challengeId = document.getElementById('challengeId').value;
            
            if (!challengeId) {
                wsClient.log('请输入挑战ID', 'error');
                return;
            }
            
            const unsubscribeMessage = {
                type: 'unsubscribe',
                challengeId: parseInt(challengeId)
            };
            
            wsClient.sendMessage(unsubscribeMessage);
            wsClient.subscribedChallenges.delete(parseInt(challengeId));
            wsClient.updateButtons();
            wsClient.log(`已取消订阅挑战 #${challengeId}`, 'success');
        }
        
        // 更新挑战进度
        function updateChallengeProgress() {
            const currentSteps = document.getElementById('currentSteps').value;
            const targetSteps = document.getElementById('targetSteps').value;
            const challengeId = document.getElementById('challengeId').value;
            
            if (!currentSteps || !targetSteps || !challengeId) {
                wsClient.log('请输入完整的挑战信息', 'error');
                return;
            }
            
            const progressMessage = {
                type: 'challenge_progress',
                challengeId: parseInt(challengeId),
                currentSteps: parseInt(currentSteps),
                targetSteps: parseInt(targetSteps)
            };
            
            wsClient.sendMessage(progressMessage);
        }
        
        // 完成挑战
        function completeChallenge() {
            const challengeId = document.getElementById('challengeId').value;
            
            if (!challengeId) {
                wsClient.log('请输入挑战ID', 'error');
                return;
            }
            
            const completeMessage = {
                type: 'challenge_complete',
                challengeId: parseInt(challengeId)
            };
            
            wsClient.sendMessage(completeMessage);
        }
        
        // 清空日志
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry"><span class="log-timestamp">[系统]</span><span class="log-message">日志已清空</span></div>';
        }
        
        // 导出日志
        function exportLog() {
            const logContainer = document.getElementById('logContainer');
            const logText = logContainer.innerText;
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `websocket-test-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            wsClient.log('WebSocket测试页面已加载完成', 'success');
            wsClient.updateConnectionStatus();
        });
    </script>
</body>
</html>
